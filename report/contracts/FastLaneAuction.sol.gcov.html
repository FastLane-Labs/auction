<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - lcov.info - contracts/FastLaneAuction.sol</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">contracts</a> - FastLaneAuction.sol<span style="font-size: 80%;"> (source / <a href="FastLaneAuction.sol.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">lcov.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">175</td>
            <td class="headerCovTableEntry">175</td>
            <td class="headerCovTableEntryHi">100.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2022-08-30 00:50:20</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">41</td>
            <td class="headerCovTableEntry">41</td>
            <td class="headerCovTableEntryHi">100.0 %</td>
          </tr>
          <tr>
            <td></td>
            <td></td>
            <td></td>
            <td class="headerItem">Branches:</td>
            <td class="headerCovTableEntry">66</td>
            <td class="headerCovTableEntry">74</td>
            <td class="headerCovTableEntryMed">89.2 %</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">           Branch data     Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>                :            : //SPDX-License-Identifier: Unlicensed</a>
<a name="2"><span class="lineNum">       2 </span>                :            : pragma solidity 0.8.16;</a>
<a name="3"><span class="lineNum">       3 </span>                :            : </a>
<a name="4"><span class="lineNum">       4 </span>                :            : import &quot;openzeppelin-contracts/contracts/utils/Address.sol&quot;;</a>
<a name="5"><span class="lineNum">       5 </span>                :            : import &quot;openzeppelin-contracts/contracts/access/Ownable.sol&quot;;</a>
<a name="6"><span class="lineNum">       6 </span>                :            : import { SafeTransferLib, ERC20 } from &quot;solmate/utils/SafeTransferLib.sol&quot;;</a>
<a name="7"><span class="lineNum">       7 </span>                :            : import &quot;openzeppelin-contracts/contracts/utils/structs/EnumerableSet.sol&quot;;</a>
<a name="8"><span class="lineNum">       8 </span>                :            : </a>
<a name="9"><span class="lineNum">       9 </span>                :            : import &quot;openzeppelin-contracts/contracts/security/ReentrancyGuard.sol&quot;;</a>
<a name="10"><span class="lineNum">      10 </span>                :            : </a>
<a name="11"><span class="lineNum">      11 </span>                :            : /// @notice Auction bid struct</a>
<a name="12"><span class="lineNum">      12 </span>                :            : /// @dev Current owners need to allow opportunity and validator addresses to participate beforehands</a>
<a name="13"><span class="lineNum">      13 </span>                :            : /// @param validatorAddress Validator selected for the bid</a>
<a name="14"><span class="lineNum">      14 </span>                :            : /// @param opportunityAddress Opportunity selected for the bid</a>
<a name="15"><span class="lineNum">      15 </span>                :            : /// @param searcherContractAddress Contract that will be submitting transactions to `opportunityAddress`</a>
<a name="16"><span class="lineNum">      16 </span>                :            : /// @param searcherPayableAddress Searcher submitting the bid (currently restricted to msg.sender)</a>
<a name="17"><span class="lineNum">      17 </span>                :            : /// @param bidAmount Value of the bid</a>
<a name="18"><span class="lineNum">      18 </span>                :            : struct Bid {</a>
<a name="19"><span class="lineNum">      19 </span>                :            :     address validatorAddress;</a>
<a name="20"><span class="lineNum">      20 </span>                :            :     address opportunityAddress;</a>
<a name="21"><span class="lineNum">      21 </span>                :            :     address searcherContractAddress;</a>
<a name="22"><span class="lineNum">      22 </span>                :            :     address searcherPayableAddress;</a>
<a name="23"><span class="lineNum">      23 </span>                :            :     uint256 bidAmount;</a>
<a name="24"><span class="lineNum">      24 </span>                :            : }</a>
<a name="25"><span class="lineNum">      25 </span>                :            : </a>
<a name="26"><span class="lineNum">      26 </span>                :            : /// @notice The type of a Status struct validator or opportunity</a>
<a name="27"><span class="lineNum">      27 </span>                :            : enum statusType {</a>
<a name="28"><span class="lineNum">      28 </span>                :            :     INVALID, // 0</a>
<a name="29"><span class="lineNum">      29 </span>                :            :     VALIDATOR, // 1 </a>
<a name="30"><span class="lineNum">      30 </span>                :            :     OPPORTUNITY // 2</a>
<a name="31"><span class="lineNum">      31 </span>                :            : }</a>
<a name="32"><span class="lineNum">      32 </span>                :            : </a>
<a name="33"><span class="lineNum">      33 </span>                :            : /// @notice Status of validator or opportunity</a>
<a name="34"><span class="lineNum">      34 </span>                :            : /// @dev Status cannot be flipped for the current round, an opportunity or validator set up as inactive will always be able to receive bids until the end of the round it was triggered.</a>
<a name="35"><span class="lineNum">      35 </span>                :            : /// @param activeAtAuctionRound Auction round where entity will be enabled</a>
<a name="36"><span class="lineNum">      36 </span>                :            : /// @param inactiveAtAuctionRound Auction round at which entity will be disabled</a>
<a name="37"><span class="lineNum">      37 </span>                :            : /// @param kind From {statusType} </a>
<a name="38"><span class="lineNum">      38 </span>                :            : struct Status {</a>
<a name="39"><span class="lineNum">      39 </span>                :            :     uint128 activeAtAuctionRound;</a>
<a name="40"><span class="lineNum">      40 </span>                :            :     uint128 inactiveAtAuctionRound;</a>
<a name="41"><span class="lineNum">      41 </span>                :            :     statusType kind;  </a>
<a name="42"><span class="lineNum">      42 </span>                :            : }</a>
<a name="43"><span class="lineNum">      43 </span>                :            : </a>
<a name="44"><span class="lineNum">      44 </span>                :            : </a>
<a name="45"><span class="lineNum">      45 </span>                :            : /// @notice Validator Balance Checkpoint</a>
<a name="46"><span class="lineNum">      46 </span>                :            : /// @dev By default checkpoints are checked every block by ops to see if there is amount to be paid ( &gt; minAmount or &gt; minAmoutForValidator)</a>
<a name="47"><span class="lineNum">      47 </span>                :            : /// @param pendingBalanceAtlastBid Deposits at `lastBidReceivedAuction`</a>
<a name="48"><span class="lineNum">      48 </span>                :            : /// @param outstandingBalance Balance accumulated between `lastWithdrawnAuction` and `lastBidReceivedAuction`</a>
<a name="49"><span class="lineNum">      49 </span>                :            : /// @param lastWithdrawnAuction Round when the validator withdrew</a>
<a name="50"><span class="lineNum">      50 </span>                :            : /// @param lastBidReceivedAuction Last auction around a bid was received for this validator</a>
<a name="51"><span class="lineNum">      51 </span>                :            : struct ValidatorBalanceCheckpoint {</a>
<a name="52"><span class="lineNum">      52 </span>                :            :     uint256 pendingBalanceAtlastBid;</a>
<a name="53"><span class="lineNum">      53 </span>                :            :     uint256 outstandingBalance;</a>
<a name="54"><span class="lineNum">      54 </span>                :            :     uint128 lastWithdrawnAuction;</a>
<a name="55"><span class="lineNum">      55 </span>                :            :     uint128 lastBidReceivedAuction;</a>
<a name="56"><span class="lineNum">      56 </span>                :            : }</a>
<a name="57"><span class="lineNum">      57 </span>                :            : </a>
<a name="58"><span class="lineNum">      58 </span>                :            : /// @notice Validator Balances Shipping Preferences</a>
<a name="59"><span class="lineNum">      59 </span>                :            : /// @dev minAutoshipAmount will always be superseeded by contract level minAutoShipThreshold if lower</a>
<a name="60"><span class="lineNum">      60 </span>                :            : /// @param minAutoshipAmount Validator desired autoship threshold </a>
<a name="61"><span class="lineNum">      61 </span>                :            : /// @param validatorPayableAddress Validator desired payable address</a>
<a name="62"><span class="lineNum">      62 </span>                :            : struct ValidatorPreferences {</a>
<a name="63"><span class="lineNum">      63 </span>                :            :     uint256 minAutoshipAmount;</a>
<a name="64"><span class="lineNum">      64 </span>                :            :     address validatorPayableAddress;</a>
<a name="65"><span class="lineNum">      65 </span>                :            : }</a>
<a name="66"><span class="lineNum">      66 </span>                :            : </a>
<a name="67"><span class="lineNum">      67 </span>                :            : </a>
<a name="68"><span class="lineNum">      68 </span>                :            : abstract contract FastLaneEvents {</a>
<a name="69"><span class="lineNum">      69 </span>                :            :     /***********************************|</a>
<a name="70"><span class="lineNum">      70 </span>                :            :     |             Events                |</a>
<a name="71"><span class="lineNum">      71 </span>                :            :     |__________________________________*/</a>
<a name="72"><span class="lineNum">      72 </span>                :            : </a>
<a name="73"><span class="lineNum">      73 </span>                :            :     event MinimumBidIncrementSet(uint256 amount);</a>
<a name="74"><span class="lineNum">      74 </span>                :            :     event FastLaneFeeSet(uint256 amount);</a>
<a name="75"><span class="lineNum">      75 </span>                :            :     event BidTokenSet(address indexed token);</a>
<a name="76"><span class="lineNum">      76 </span>                :            :     event PausedStateSet(bool state);</a>
<a name="77"><span class="lineNum">      77 </span>                :            :     event OpsSet(address ops);</a>
<a name="78"><span class="lineNum">      78 </span>                :            :     event MinimumAutoshipThresholdSet(uint128 amount);</a>
<a name="79"><span class="lineNum">      79 </span>                :            :     event ResolverMaxGasPriceSet(uint128 amount);</a>
<a name="80"><span class="lineNum">      80 </span>                :            :     event AutopayBatchSizeSet(uint16 batch_size);</a>
<a name="81"><span class="lineNum">      81 </span>                :            :     event OpportunityAddressEnabled(</a>
<a name="82"><span class="lineNum">      82 </span>                :            :         address indexed opportunity,</a>
<a name="83"><span class="lineNum">      83 </span>                :            :         uint128 indexed auction_number</a>
<a name="84"><span class="lineNum">      84 </span>                :            :     );</a>
<a name="85"><span class="lineNum">      85 </span>                :            :     event OpportunityAddressDisabled(</a>
<a name="86"><span class="lineNum">      86 </span>                :            :         address indexed opportunity,</a>
<a name="87"><span class="lineNum">      87 </span>                :            :         uint128 indexed auction_number</a>
<a name="88"><span class="lineNum">      88 </span>                :            :     );</a>
<a name="89"><span class="lineNum">      89 </span>                :            :     event ValidatorAddressEnabled(</a>
<a name="90"><span class="lineNum">      90 </span>                :            :         address indexed validator,</a>
<a name="91"><span class="lineNum">      91 </span>                :            :         uint128 indexed auction_number</a>
<a name="92"><span class="lineNum">      92 </span>                :            :     );</a>
<a name="93"><span class="lineNum">      93 </span>                :            :     event ValidatorAddressDisabled(</a>
<a name="94"><span class="lineNum">      94 </span>                :            :         address indexed validator,</a>
<a name="95"><span class="lineNum">      95 </span>                :            :         uint128 indexed auction_number</a>
<a name="96"><span class="lineNum">      96 </span>                :            :     );</a>
<a name="97"><span class="lineNum">      97 </span>                :            :     event ValidatorWithdrawnBalance(</a>
<a name="98"><span class="lineNum">      98 </span>                :            :         address indexed validator,</a>
<a name="99"><span class="lineNum">      99 </span>                :            :         uint128 indexed auction_number,</a>
<a name="100"><span class="lineNum">     100 </span>                :            :         uint256 amount,</a>
<a name="101"><span class="lineNum">     101 </span>                :            :         address destination,</a>
<a name="102"><span class="lineNum">     102 </span>                :            :         address indexed caller</a>
<a name="103"><span class="lineNum">     103 </span>                :            : </a>
<a name="104"><span class="lineNum">     104 </span>                :            :     );</a>
<a name="105"><span class="lineNum">     105 </span>                :            :     event AuctionStarted(uint128 indexed auction_number);</a>
<a name="106"><span class="lineNum">     106 </span>                :            : </a>
<a name="107"><span class="lineNum">     107 </span>                :            :     event AuctionEnded(uint128 indexed auction_number);</a>
<a name="108"><span class="lineNum">     108 </span>                :            : </a>
<a name="109"><span class="lineNum">     109 </span>                :            :     event AuctionStarterSet(address indexed starter);</a>
<a name="110"><span class="lineNum">     110 </span>                :            : </a>
<a name="111"><span class="lineNum">     111 </span>                :            :     event WithdrawStuckERC20(</a>
<a name="112"><span class="lineNum">     112 </span>                :            :         address indexed receiver,</a>
<a name="113"><span class="lineNum">     113 </span>                :            :         address indexed token,</a>
<a name="114"><span class="lineNum">     114 </span>                :            :         uint256 amount</a>
<a name="115"><span class="lineNum">     115 </span>                :            :     );</a>
<a name="116"><span class="lineNum">     116 </span>                :            :     event WithdrawStuckNativeToken(address indexed receiver, uint256 amount);</a>
<a name="117"><span class="lineNum">     117 </span>                :            :    </a>
<a name="118"><span class="lineNum">     118 </span>                :            :     event BidAdded(</a>
<a name="119"><span class="lineNum">     119 </span>                :            :         address bidder,</a>
<a name="120"><span class="lineNum">     120 </span>                :            :         address indexed validator,</a>
<a name="121"><span class="lineNum">     121 </span>                :            :         address indexed opportunity,</a>
<a name="122"><span class="lineNum">     122 </span>                :            :         uint256 amount,</a>
<a name="123"><span class="lineNum">     123 </span>                :            :         uint256 indexed auction_number</a>
<a name="124"><span class="lineNum">     124 </span>                :            :     );</a>
<a name="125"><span class="lineNum">     125 </span>                :            : </a>
<a name="126"><span class="lineNum">     126 </span>                :            :     event ValidatorPreferencesSet(address indexed validator, uint256 minAutoshipAmount, address validatorPayableAddress);</a>
<a name="127"><span class="lineNum">     127 </span>                :            : </a>
<a name="128"><span class="lineNum">     128 </span>                :            :     error GeneralFailure();                            // E-000 // 0x2192efec</a>
<a name="129"><span class="lineNum">     129 </span>                :            : </a>
<a name="130"><span class="lineNum">     130 </span>                :            :     error PermissionPaused();                          // E-101 // 0xeaa8b1af</a>
<a name="131"><span class="lineNum">     131 </span>                :            :     error PermissionNotOwner();                        // E-102 // 0xf599ea9e</a>
<a name="132"><span class="lineNum">     132 </span>                :            :     error PermissionOnlyFromPayorEoa();                // E-103 // 0x13272381</a>
<a name="133"><span class="lineNum">     133 </span>                :            :     error PermissionMustBeValidator();                 // E-104 // 0x4f4e9f3f</a>
<a name="134"><span class="lineNum">     134 </span>                :            :     error PermissionInvalidOpportunityAddress();       // E-105 // 0xcf440a8e</a>
<a name="135"><span class="lineNum">     135 </span>                :            :     error PermissionOnlyOps();                         // E-106 // 0x68da148f</a>
<a name="136"><span class="lineNum">     136 </span>                :            :     error PermissionNotOwnerNorStarter();              // E-107 // 0x8b4fb0bf</a>
<a name="137"><span class="lineNum">     137 </span>                :            : </a>
<a name="138"><span class="lineNum">     138 </span>                :            :     error InequalityInvalidIndex();                    // E-201 // 0x102bd785</a>
<a name="139"><span class="lineNum">     139 </span>                :            :     error InequalityAddressMismatch();                 // E-202 // 0x17de231a</a>
<a name="140"><span class="lineNum">     140 </span>                :            :     error InequalityTooLow();                          // E-203 // 0x470b0adc</a>
<a name="141"><span class="lineNum">     141 </span>                :            :     error InequalityAlreadyTopBidder();                // E-204 // 0xeb14a775</a>
<a name="142"><span class="lineNum">     142 </span>                :            :     error InequalityNotEnoughFunds();                  // E-206 // 0x4587f24a</a>
<a name="143"><span class="lineNum">     143 </span>                :            :     error InequalityNothingToRedeem();                 // E-207 // 0x77a3b272</a>
<a name="144"><span class="lineNum">     144 </span>                :            :     error InequalityValidatorDisabledAtTime();         // E-209 // 0xa1ec46e6</a>
<a name="145"><span class="lineNum">     145 </span>                :            :     error InequalityOpportunityDisabledAtTime();       // E-210 // 0x8c81d8e9</a>
<a name="146"><span class="lineNum">     146 </span>                :            :     error InequalityValidatorNotEnabledYet();          // E-211 // 0x7a956c2e</a>
<a name="147"><span class="lineNum">     147 </span>                :            :     error InequalityOpportunityNotEnabledYet();        // E-212 // 0x333108d7</a>
<a name="148"><span class="lineNum">     148 </span>                :            :     error InequalityTooHigh();                         // E-213 // 0xfd11d092</a>
<a name="149"><span class="lineNum">     149 </span>                :            :     error InequalityWrongToken();                      // E-214 // 0xc9db890c</a>
<a name="150"><span class="lineNum">     150 </span>                :            : </a>
<a name="151"><span class="lineNum">     151 </span>                :            :     error TimeNotWhenAuctionIsLive();                  // E-301 // 0x76a79c50</a>
<a name="152"><span class="lineNum">     152 </span>                :            :     error TimeNotWhenAuctionIsStopped();               // E-302 // 0x4eaf4896</a>
<a name="153"><span class="lineNum">     153 </span>                :            :     error TimeGasNotSuitable();                        // E-307 // 0xdd980aae</a>
<a name="154"><span class="lineNum">     154 </span>                :            :     error TimeAlreadyInit();                           // E-308 // 0xef34ca5c</a>
<a name="155"><span class="lineNum">     155 </span>                :            : </a>
<a name="156"><span class="lineNum">     156 </span>                :            : }   </a>
<a name="157"><span class="lineNum">     157 </span>                :            : </a>
<a name="158"><span class="lineNum">     158 </span>                :            : /// @title FastLaneAuction</a>
<a name="159"><span class="lineNum">     159 </span>                :            : /// @author Elyx0</a>
<a name="160"><span class="lineNum">     160 </span>                :            : /// @notice Fastlane.finance auction contract</a>
<a name="161"><span class="lineNum">     161 </span>                :            : contract FastLaneAuction is FastLaneEvents, Ownable, ReentrancyGuard {</a>
<a name="162"><span class="lineNum">     162 </span>                :            :     using Address for address payable;</a>
<a name="163"><span class="lineNum">     163 </span>                :            :     using EnumerableSet for EnumerableSet.AddressSet;</a>
<a name="164"><span class="lineNum">     164 </span>                :            :     using SafeTransferLib for ERC20;</a>
<a name="165"><span class="lineNum">     165 </span>                :            : </a>
<a name="166"><span class="lineNum">     166 </span>                :            :     ERC20 public bid_token;</a>
<a name="167"><span class="lineNum">     167 </span>                :            : </a>
<a name="168"><span class="lineNum">     168 </span>                :            : </a>
<a name="169"><span class="lineNum">     169 </span>                :            :     /// @notice Initializes the auction</a>
<a name="170"><span class="lineNum">     170 </span>                :            :     /// @dev Also sets bid increment, resolver max gas, fee, autoship and batch size.</a>
<a name="171"><span class="lineNum">     171 </span>                :            :     /// @param _initial_bid_token ERC20 address to use for the auction</a>
<a name="172"><span class="lineNum">     172 </span>                :            :     /// @param _ops Operators address for crontabs</a>
<a name="173"><span class="lineNum">     173 </span>                :            :     /// @param _starter Address allowed to start/stop rounds</a>
<a name="174"><span class="lineNum">     174 </span>                :            :     function initialSetupAuction(address _initial_bid_token, address _ops, address _starter) external onlyOwner {</a>
<a name="175"><span class="lineNum">     175 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          2 :         if (auctionInitialized) revert TimeAlreadyInit();</span></a>
<a name="176"><span class="lineNum">     176 </span>                :<span class="lineCov">          1 :         setBidToken(_initial_bid_token);</span></a>
<a name="177"><span class="lineNum">     177 </span>                :<span class="lineCov">          1 :         setOps(_ops);</span></a>
<a name="178"><span class="lineNum">     178 </span>                :<span class="lineCov">          1 :         auction_number = 1;</span></a>
<a name="179"><span class="lineNum">     179 </span>                :<span class="lineCov">          1 :         setMinimumBidIncrement(10* (10**18));</span></a>
<a name="180"><span class="lineNum">     180 </span>                :<span class="lineCov">          1 :         setMinimumAutoShipThreshold(2000* (10**18));</span></a>
<a name="181"><span class="lineNum">     181 </span>                :<span class="lineCov">          1 :         setResolverMaxGasPrice(200 gwei);</span></a>
<a name="182"><span class="lineNum">     182 </span>                :<span class="lineCov">          1 :         setFastlaneFee(50000);</span></a>
<a name="183"><span class="lineNum">     183 </span>                :<span class="lineCov">          1 :         setAutopayBatchSize(10); </span></a>
<a name="184"><span class="lineNum">     184 </span>                :<span class="lineCov">          1 :         setStarter(_starter);</span></a>
<a name="185"><span class="lineNum">     185 </span>                :<span class="lineCov">          1 :         auctionInitialized = true;</span></a>
<a name="186"><span class="lineNum">     186 </span>                :            :     }</a>
<a name="187"><span class="lineNum">     187 </span>                :            : </a>
<a name="188"><span class="lineNum">     188 </span>                :            :     /// @notice Gelato Ops Address</a>
<a name="189"><span class="lineNum">     189 </span>                :            :     address public ops;</a>
<a name="190"><span class="lineNum">     190 </span>                :            : </a>
<a name="191"><span class="lineNum">     191 </span>                :            :     // Variables mutable by owner via function calls</a>
<a name="192"><span class="lineNum">     192 </span>                :            : </a>
<a name="193"><span class="lineNum">     193 </span>                :            :     /// @notice Minimum bid increment required on top of from the current top bid for a pair</a>
<a name="194"><span class="lineNum">     194 </span>                :            :     uint256 public bid_increment = 10 * (10**18);</a>
<a name="195"><span class="lineNum">     195 </span>                :            : </a>
<a name="196"><span class="lineNum">     196 </span>                :            : </a>
<a name="197"><span class="lineNum">     197 </span>                :            :     /// @notice Minimum amount for Validator Preferences to get the profits airdropped</a>
<a name="198"><span class="lineNum">     198 </span>                :            :     uint128 public minAutoShipThreshold = 2000 * (10**18); // Validators balances &gt; 2k should get auto-transfered</a>
<a name="199"><span class="lineNum">     199 </span>                :            : </a>
<a name="200"><span class="lineNum">     200 </span>                :            :     /// @notice Current auction round, </a>
<a name="201"><span class="lineNum">     201 </span>                :            :     /// @dev Offset by 1 so payouts are at 0. In general payouts are for round n-1.</a>
<a name="202"><span class="lineNum">     202 </span>                :            :     uint128 public auction_number = 1;</a>
<a name="203"><span class="lineNum">     203 </span>                :            : </a>
<a name="204"><span class="lineNum">     204 </span>                :            :     uint128 public constant MAX_AUCTION_VALUE = type(uint128).max; // 2**128 - 1</a>
<a name="205"><span class="lineNum">     205 </span>                :            : </a>
<a name="206"><span class="lineNum">     206 </span>                :            :     /// @notice Max gas price for ops to attempt autopaying pending balances over threshold</a>
<a name="207"><span class="lineNum">     207 </span>                :            :     uint128 public max_gas_price = 200 gwei;</a>
<a name="208"><span class="lineNum">     208 </span>                :            : </a>
<a name="209"><span class="lineNum">     209 </span>                :            :     /// @notice Fee (out of one million)</a>
<a name="210"><span class="lineNum">     210 </span>                :            :     uint24 public fast_lane_fee = 50000; </a>
<a name="211"><span class="lineNum">     211 </span>                :            : </a>
<a name="212"><span class="lineNum">     212 </span>                :            :     /// @notice Number of validators to pay per gelato action</a>
<a name="213"><span class="lineNum">     213 </span>                :            :     uint16 public autopay_batch_size = 10;</a>
<a name="214"><span class="lineNum">     214 </span>                :            : </a>
<a name="215"><span class="lineNum">     215 </span>                :            :     /// @notice Auction live status</a>
<a name="216"><span class="lineNum">     216 </span>                :            :     bool public auction_live = false;</a>
<a name="217"><span class="lineNum">     217 </span>                :            : </a>
<a name="218"><span class="lineNum">     218 </span>                :            :     bool internal paused = false;</a>
<a name="219"><span class="lineNum">     219 </span>                :            : </a>
<a name="220"><span class="lineNum">     220 </span>                :            :     /// @notice Ops crontab disabled</a>
<a name="221"><span class="lineNum">     221 </span>                :            :     bool internal _offchain_checker_disabled = false;</a>
<a name="222"><span class="lineNum">     222 </span>                :            : </a>
<a name="223"><span class="lineNum">     223 </span>                :            :     /// @notice Tracks status of seen addresses and when they become eligible for bidding</a>
<a name="224"><span class="lineNum">     224 </span>                :            :     mapping(address =&gt; Status) internal statusMap;</a>
<a name="225"><span class="lineNum">     225 </span>                :            : </a>
<a name="226"><span class="lineNum">     226 </span>                :            :     /// @notice Tracks bids per auction_number per pair</a>
<a name="227"><span class="lineNum">     227 </span>                :            :     mapping(uint256 =&gt; mapping(address =&gt; mapping(address =&gt; Bid)))</a>
<a name="228"><span class="lineNum">     228 </span>                :            :         internal auctionsMap;</a>
<a name="229"><span class="lineNum">     229 </span>                :            : </a>
<a name="230"><span class="lineNum">     230 </span>                :            :     /// @notice Validators participating in the auction for a round</a>
<a name="231"><span class="lineNum">     231 </span>                :            :     mapping(uint128 =&gt; EnumerableSet.AddressSet) internal validatorsactiveAtAuctionRound;</a>
<a name="232"><span class="lineNum">     232 </span>                :            : </a>
<a name="233"><span class="lineNum">     233 </span>                :            :     /// @notice Validators cuts to be withdraw or dispatched regularly</a>
<a name="234"><span class="lineNum">     234 </span>                :            :     mapping(address =&gt; ValidatorBalanceCheckpoint) internal validatorsCheckpoints;</a>
<a name="235"><span class="lineNum">     235 </span>                :            : </a>
<a name="236"><span class="lineNum">     236 </span>                :            :     /// @notice Validator preferences for payment and min autoship amount</a>
<a name="237"><span class="lineNum">     237 </span>                :            :     mapping(address =&gt; ValidatorPreferences) internal validatorsPreferences;</a>
<a name="238"><span class="lineNum">     238 </span>                :            : </a>
<a name="239"><span class="lineNum">     239 </span>                :            :     /// @notice Auto cleared by EndAuction every round</a>
<a name="240"><span class="lineNum">     240 </span>                :            :     uint256 public outstandingFLBalance = 0;</a>
<a name="241"><span class="lineNum">     241 </span>                :            : </a>
<a name="242"><span class="lineNum">     242 </span>                :            :     /// @notice Start &amp; Stop auction role</a>
<a name="243"><span class="lineNum">     243 </span>                :            :     address public auctionStarter;</a>
<a name="244"><span class="lineNum">     244 </span>                :            : </a>
<a name="245"><span class="lineNum">     245 </span>                :            :     /// @notice Auction was initialized</a>
<a name="246"><span class="lineNum">     246 </span>                :            :     bool public auctionInitialized = false;</a>
<a name="247"><span class="lineNum">     247 </span>                :            : </a>
<a name="248"><span class="lineNum">     248 </span>                :            :     /// @notice Internally updates a validator preference</a>
<a name="249"><span class="lineNum">     249 </span>                :            :     /// @dev Only callable by an already setup validator, and only for themselves via {setValidatorPreferences}</a>
<a name="250"><span class="lineNum">     250 </span>                :            :     /// @param _target Validator to update</a>
<a name="251"><span class="lineNum">     251 </span>                :            :     /// @param _minAutoshipAmount Amount desired before autoship kicks in</a>
<a name="252"><span class="lineNum">     252 </span>                :            :     /// @param _validatorPayableAddress Address the auction proceeds will go to for this validator</a>
<a name="253"><span class="lineNum">     253 </span>                :            :     function _updateValidatorPreferences(address _target, uint128 _minAutoshipAmount, address _validatorPayableAddress) internal {</a>
<a name="254"><span class="lineNum">     254 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 10 times"> + </span>]:<span class="lineCov">         11 :         if(_minAutoshipAmount &lt; minAutoShipThreshold) revert InequalityTooLow();</span></a>
<a name="255"><span class="lineNum">     255 </span>        [<span class="branchCov" title="Branch 0 was taken 10 times"> + </span><span class="branchCov" title="Branch 1 was taken 10 times"> + </span>]:<span class="lineCov">         10 :         if((_validatorPayableAddress == address(0)) || (_validatorPayableAddress == address(this))) revert InequalityAddressMismatch();</span></a>
<a name="256"><span class="lineNum">     256 </span>                :            :         </a>
<a name="257"><span class="lineNum">     257 </span>                :<span class="lineCov">          9 :         validatorsPreferences[_target] = ValidatorPreferences(_minAutoshipAmount, _validatorPayableAddress);</span></a>
<a name="258"><span class="lineNum">     258 </span>                :<span class="lineCov">          9 :         emit ValidatorPreferencesSet(_target,_minAutoshipAmount, _validatorPayableAddress);</span></a>
<a name="259"><span class="lineNum">     259 </span>                :            :     }</a>
<a name="260"><span class="lineNum">     260 </span>                :            : </a>
<a name="261"><span class="lineNum">     261 </span>                :            :     /***********************************|</a>
<a name="262"><span class="lineNum">     262 </span>                :            :     |         Validator-only            |</a>
<a name="263"><span class="lineNum">     263 </span>                :            :     |__________________________________*/</a>
<a name="264"><span class="lineNum">     264 </span>                :            : </a>
<a name="265"><span class="lineNum">     265 </span>                :            :     /// @notice Internally updates a validator preference</a>
<a name="266"><span class="lineNum">     266 </span>                :            :     /// @dev Only callable by an already setup validator via {onlyValidator}</a>
<a name="267"><span class="lineNum">     267 </span>                :            :     /// @param _minAutoshipAmount Amount desired before autoship kicks in</a>
<a name="268"><span class="lineNum">     268 </span>                :            :     /// @param _validatorPayableAddress Address the auction proceeds will go to for this validator</a>
<a name="269"><span class="lineNum">     269 </span>                :            :     function setValidatorPreferences(uint128 _minAutoshipAmount, address _validatorPayableAddress) external onlyValidator {</a>
<a name="270"><span class="lineNum">     270 </span>                :<span class="lineCov">          4 :         _updateValidatorPreferences(msg.sender, _minAutoshipAmount, _validatorPayableAddress);</span></a>
<a name="271"><span class="lineNum">     271 </span>                :            :     }</a>
<a name="272"><span class="lineNum">     272 </span>                :            : </a>
<a name="273"><span class="lineNum">     273 </span>                :            :     /***********************************|</a>
<a name="274"><span class="lineNum">     274 </span>                :            :     |             Owner-only            |</a>
<a name="275"><span class="lineNum">     275 </span>                :            :     |__________________________________*/</a>
<a name="276"><span class="lineNum">     276 </span>                :            : </a>
<a name="277"><span class="lineNum">     277 </span>                :            :     /// @notice Defines the paused state of the Auction</a>
<a name="278"><span class="lineNum">     278 </span>                :            :     /// @dev Only owner</a>
<a name="279"><span class="lineNum">     279 </span>                :            :     /// @param _state New state</a>
<a name="280"><span class="lineNum">     280 </span>                :            :     function setPausedState(bool _state) external onlyOwner {</a>
<a name="281"><span class="lineNum">     281 </span>                :<span class="lineCov">          1 :         paused = _state;</span></a>
<a name="282"><span class="lineNum">     282 </span>                :<span class="lineCov">          1 :         emit PausedStateSet(_state);</span></a>
<a name="283"><span class="lineNum">     283 </span>                :            :     }</a>
<a name="284"><span class="lineNum">     284 </span>                :            : </a>
<a name="285"><span class="lineNum">     285 </span>                :            :     /// @notice Sets minimum bid increment </a>
<a name="286"><span class="lineNum">     286 </span>                :            :     /// @dev Used to avoid people micro-bidding up by .000000001</a>
<a name="287"><span class="lineNum">     287 </span>                :            :     /// @param _bid_increment New increment</a>
<a name="288"><span class="lineNum">     288 </span>                :            :     function setMinimumBidIncrement(uint256 _bid_increment) public onlyOwner {</a>
<a name="289"><span class="lineNum">     289 </span>                :<span class="lineCov">          3 :         bid_increment = _bid_increment;</span></a>
<a name="290"><span class="lineNum">     290 </span>                :<span class="lineCov">          3 :         emit MinimumBidIncrementSet(_bid_increment);</span></a>
<a name="291"><span class="lineNum">     291 </span>                :            :     }</a>
<a name="292"><span class="lineNum">     292 </span>                :            : </a>
<a name="293"><span class="lineNum">     293 </span>                :            :     /// @notice Sets address of Ops</a>
<a name="294"><span class="lineNum">     294 </span>                :            :     /// @dev Ops is allowed to call {processAutopayJobs}</a>
<a name="295"><span class="lineNum">     295 </span>                :            :     /// @param _ops New operator of crontabs</a>
<a name="296"><span class="lineNum">     296 </span>                :            :     function setOps(address _ops) public onlyOwner {</a>
<a name="297"><span class="lineNum">     297 </span>                :<span class="lineCov">          2 :         ops = _ops;</span></a>
<a name="298"><span class="lineNum">     298 </span>                :<span class="lineCov">          2 :         emit OpsSet(_ops);</span></a>
<a name="299"><span class="lineNum">     299 </span>                :            :     }</a>
<a name="300"><span class="lineNum">     300 </span>                :            : </a>
<a name="301"><span class="lineNum">     301 </span>                :            :     /// @notice Sets minimum balance a checkpoint must meet to be considered for autoship</a>
<a name="302"><span class="lineNum">     302 </span>                :            :     /// @dev This amount will always override validator preferences if greater</a>
<a name="303"><span class="lineNum">     303 </span>                :            :     /// @param _minAmount Minimum amount</a>
<a name="304"><span class="lineNum">     304 </span>                :            :     function setMinimumAutoShipThreshold(uint128 _minAmount) public onlyOwner {</a>
<a name="305"><span class="lineNum">     305 </span>                :<span class="lineCov">          5 :         minAutoShipThreshold = _minAmount;</span></a>
<a name="306"><span class="lineNum">     306 </span>                :<span class="lineCov">          5 :         emit MinimumAutoshipThresholdSet(_minAmount);</span></a>
<a name="307"><span class="lineNum">     307 </span>                :            :     }</a>
<a name="308"><span class="lineNum">     308 </span>                :            : </a>
<a name="309"><span class="lineNum">     309 </span>                :            :     /// @notice Sets maximum network gas for autoship</a>
<a name="310"><span class="lineNum">     310 </span>                :            :     /// @dev Past this value autoship will have to be manually called until gwei goes lower or this gets upped</a>
<a name="311"><span class="lineNum">     311 </span>                :            :     /// @param _maxgas Maximum gas</a>
<a name="312"><span class="lineNum">     312 </span>                :            :     function setResolverMaxGasPrice(uint128 _maxgas) public onlyOwner {</a>
<a name="313"><span class="lineNum">     313 </span>                :<span class="lineCov">          3 :         max_gas_price = _maxgas;</span></a>
<a name="314"><span class="lineNum">     314 </span>                :<span class="lineCov">          3 :         emit ResolverMaxGasPriceSet(_maxgas);</span></a>
<a name="315"><span class="lineNum">     315 </span>                :            :     }</a>
<a name="316"><span class="lineNum">     316 </span>                :            : </a>
<a name="317"><span class="lineNum">     317 </span>                :            :     /// @notice Sets the protocol fee (out of 1000000 (ie v2 fee decimals))</a>
<a name="318"><span class="lineNum">     318 </span>                :            :     /// @dev Initially set to 50000 (5%) For now we can't change the fee during an ongoing auction since the bids do not store the fee value at bidding time</a>
<a name="319"><span class="lineNum">     319 </span>                :            :     /// @param _fastLaneFee Protocl fee on bids</a>
<a name="320"><span class="lineNum">     320 </span>                :            :     function setFastlaneFee(uint24 _fastLaneFee)</a>
<a name="321"><span class="lineNum">     321 </span>                :            :         public</a>
<a name="322"><span class="lineNum">     322 </span>                :            :         onlyOwner</a>
<a name="323"><span class="lineNum">     323 </span>                :            :         notLiveStage</a>
<a name="324"><span class="lineNum">     324 </span>                :            :     {</a>
<a name="325"><span class="lineNum">     325 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 6 times"> + </span>]:<span class="lineCov">          7 :         if (_fastLaneFee &gt; 1000000) revert InequalityTooHigh();</span></a>
<a name="326"><span class="lineNum">     326 </span>                :<span class="lineCov">          6 :         fast_lane_fee = _fastLaneFee;</span></a>
<a name="327"><span class="lineNum">     327 </span>                :<span class="lineCov">          6 :         emit FastLaneFeeSet(_fastLaneFee);</span></a>
<a name="328"><span class="lineNum">     328 </span>                :            :     }</a>
<a name="329"><span class="lineNum">     329 </span>                :            : </a>
<a name="330"><span class="lineNum">     330 </span>                :            :     /// @notice Sets the ERC20 token that is treated as the base currency for bidding purposes</a>
<a name="331"><span class="lineNum">     331 </span>                :            :     /// @dev Initially set to WMATIC, changing it is not allowed during auctions, special considerations must be taken care of if changing this value, such as paying all outstanding validators first to not mix ERC's.</a>
<a name="332"><span class="lineNum">     332 </span>                :            :     /// @param _bid_token_address Address of the bid token</a>
<a name="333"><span class="lineNum">     333 </span>                :            :     function setBidToken(address _bid_token_address)</a>
<a name="334"><span class="lineNum">     334 </span>                :            :         public</a>
<a name="335"><span class="lineNum">     335 </span>                :            :         onlyOwner</a>
<a name="336"><span class="lineNum">     336 </span>                :            :         notLiveStage</a>
<a name="337"><span class="lineNum">     337 </span>                :            :     {</a>
<a name="338"><span class="lineNum">     338 </span>                :            :         // Prevent QBridge Finance issues</a>
<a name="339"><span class="lineNum">     339 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          2 :         if (_bid_token_address == address(0)) revert GeneralFailure();</span></a>
<a name="340"><span class="lineNum">     340 </span>                :<span class="lineCov">          1 :         bid_token = ERC20(_bid_token_address);</span></a>
<a name="341"><span class="lineNum">     341 </span>                :<span class="lineCov">          1 :         emit BidTokenSet(_bid_token_address);</span></a>
<a name="342"><span class="lineNum">     342 </span>                :            :     }</a>
<a name="343"><span class="lineNum">     343 </span>                :            : </a>
<a name="344"><span class="lineNum">     344 </span>                :            : </a>
<a name="345"><span class="lineNum">     345 </span>                :            :     /// @notice Sets the auction starter role</a>
<a name="346"><span class="lineNum">     346 </span>                :            :     /// @dev Both owner and starter will be able to trigger starts/stops</a>
<a name="347"><span class="lineNum">     347 </span>                :            :     /// @param _starter Address of the starter role</a>
<a name="348"><span class="lineNum">     348 </span>                :            :     function setStarter(address _starter) public onlyOwner {</a>
<a name="349"><span class="lineNum">     349 </span>                :<span class="lineCov">          2 :         auctionStarter = _starter;</span></a>
<a name="350"><span class="lineNum">     350 </span>                :<span class="lineCov">          2 :         emit AuctionStarterSet(auctionStarter);</span></a>
<a name="351"><span class="lineNum">     351 </span>                :            :     }</a>
<a name="352"><span class="lineNum">     352 </span>                :            : </a>
<a name="353"><span class="lineNum">     353 </span>                :            : </a>
<a name="354"><span class="lineNum">     354 </span>                :            :     /// @notice Adds an address to the allowed entity mapping as opportunity</a>
<a name="355"><span class="lineNum">     355 </span>                :            :     /// @dev Should be a router/aggregator etc. Opportunities are queued to the next auction</a>
<a name="356"><span class="lineNum">     356 </span>                :            :     /// @dev Do not use on already enabled opportunity or it will be stopped for current auction round</a>
<a name="357"><span class="lineNum">     357 </span>                :            :     /// @param _opportunityAddress Address of the opportunity</a>
<a name="358"><span class="lineNum">     358 </span>                :            :     function enableOpportunityAddress(address _opportunityAddress)</a>
<a name="359"><span class="lineNum">     359 </span>                :            :         external</a>
<a name="360"><span class="lineNum">     360 </span>                :            :         onlyOwner</a>
<a name="361"><span class="lineNum">     361 </span>                :            :     {</a>
<a name="362"><span class="lineNum">     362 </span>                :            :         // Enable for after auction ends if live</a>
<a name="363"><span class="lineNum">     363 </span>                :<span class="lineCov">         17 :         uint128 target_auction_number = auction_live ? auction_number + 1 : auction_number;</span></a>
<a name="364"><span class="lineNum">     364 </span>                :<span class="lineCov">         17 :         statusMap[_opportunityAddress] = Status(target_auction_number, MAX_AUCTION_VALUE, statusType.OPPORTUNITY);</span></a>
<a name="365"><span class="lineNum">     365 </span>                :<span class="lineCov">         17 :         emit OpportunityAddressEnabled(_opportunityAddress, target_auction_number);</span></a>
<a name="366"><span class="lineNum">     366 </span>                :            :     }</a>
<a name="367"><span class="lineNum">     367 </span>                :            : </a>
<a name="368"><span class="lineNum">     368 </span>                :            :     /// @notice Disables an opportunity</a>
<a name="369"><span class="lineNum">     369 </span>                :            :     /// @dev If auction is live, only takes effect at next round</a>
<a name="370"><span class="lineNum">     370 </span>                :            :     /// @param _opportunityAddress Address of the opportunity</a>
<a name="371"><span class="lineNum">     371 </span>                :            :     function disableOpportunityAddress(address _opportunityAddress)</a>
<a name="372"><span class="lineNum">     372 </span>                :            :         external</a>
<a name="373"><span class="lineNum">     373 </span>                :            :         onlyOwner</a>
<a name="374"><span class="lineNum">     374 </span>                :            :     {</a>
<a name="375"><span class="lineNum">     375 </span>                :<span class="lineCov">          4 :         Status storage existingStatus = statusMap[_opportunityAddress];</span></a>
<a name="376"><span class="lineNum">     376 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchCov" title="Branch 1 was taken 4 times"> + </span>]:<span class="lineCov">          4 :         if (existingStatus.kind != statusType.OPPORTUNITY) revert PermissionInvalidOpportunityAddress();</span></a>
<a name="377"><span class="lineNum">     377 </span>                :<span class="lineCov">          3 :         uint128 target_auction_number = auction_live ? auction_number + 1 : auction_number;</span></a>
<a name="378"><span class="lineNum">     378 </span>                :            : </a>
<a name="379"><span class="lineNum">     379 </span>                :<span class="lineCov">          3 :         existingStatus.inactiveAtAuctionRound = target_auction_number;</span></a>
<a name="380"><span class="lineNum">     380 </span>                :<span class="lineCov">          3 :         emit OpportunityAddressDisabled(_opportunityAddress, target_auction_number);</span></a>
<a name="381"><span class="lineNum">     381 </span>                :            :     }</a>
<a name="382"><span class="lineNum">     382 </span>                :            : </a>
<a name="383"><span class="lineNum">     383 </span>                :            :     /// @notice Internal, enables a validator checkpoint</a>
<a name="384"><span class="lineNum">     384 </span>                :            :     /// @dev If auction is live, only takes effect at next round</a>
<a name="385"><span class="lineNum">     385 </span>                :            :     /// @param _validatorAddress Address of the validator</a>
<a name="386"><span class="lineNum">     386 </span>                :            :     function _enableValidatorCheckpoint(address _validatorAddress) internal {</a>
<a name="387"><span class="lineNum">     387 </span>                :<span class="lineCov">         21 :         uint128 target_auction_number = auction_live ? auction_number + 1 : auction_number;</span></a>
<a name="388"><span class="lineNum">     388 </span>                :<span class="lineCov">         21 :         statusMap[_validatorAddress] = Status(target_auction_number, MAX_AUCTION_VALUE, statusType.VALIDATOR);</span></a>
<a name="389"><span class="lineNum">     389 </span>                :            :         </a>
<a name="390"><span class="lineNum">     390 </span>                :            :         // Create the checkpoint for the Validator</a>
<a name="391"><span class="lineNum">     391 </span>                :<span class="lineCov">         21 :         ValidatorBalanceCheckpoint memory valCheckpoint = validatorsCheckpoints[_validatorAddress];</span></a>
<a name="392"><span class="lineNum">     392 </span>        [<span class="branchCov" title="Branch 0 was taken 20 times"> + </span><span class="branchCov" title="Branch 1 was taken 21 times"> + </span>]:<span class="lineCov">         21 :         if (valCheckpoint.lastBidReceivedAuction == 0) {</span></a>
<a name="393"><span class="lineNum">     393 </span>                :<span class="lineCov">         20 :             validatorsCheckpoints[_validatorAddress] = ValidatorBalanceCheckpoint(0, 0, 0, 0);</span></a>
<a name="394"><span class="lineNum">     394 </span>                :            :         } </a>
<a name="395"><span class="lineNum">     395 </span>                :<span class="lineCov">         21 :         emit ValidatorAddressEnabled(_validatorAddress, target_auction_number);</span></a>
<a name="396"><span class="lineNum">     396 </span>                :            :     }</a>
<a name="397"><span class="lineNum">     397 </span>                :            : </a>
<a name="398"><span class="lineNum">     398 </span>                :            :     /// @notice Enables a validator checkpoint</a>
<a name="399"><span class="lineNum">     399 </span>                :            :     /// @dev If auction is live, only takes effect at next round</a>
<a name="400"><span class="lineNum">     400 </span>                :            :     /// @param _validatorAddress Address of the validator</a>
<a name="401"><span class="lineNum">     401 </span>                :            :     function enableValidatorAddress(address _validatorAddress)</a>
<a name="402"><span class="lineNum">     402 </span>                :            :         external</a>
<a name="403"><span class="lineNum">     403 </span>                :            :         onlyOwner</a>
<a name="404"><span class="lineNum">     404 </span>                :            :     {</a>
<a name="405"><span class="lineNum">     405 </span>                :<span class="lineCov">         14 :        _enableValidatorCheckpoint(_validatorAddress);</span></a>
<a name="406"><span class="lineNum">     406 </span>                :            :     }</a>
<a name="407"><span class="lineNum">     407 </span>                :            : </a>
<a name="408"><span class="lineNum">     408 </span>                :            :     /// @notice Enables a validator checkpoint and sets preferences</a>
<a name="409"><span class="lineNum">     409 </span>                :            :     /// @dev If auction is live, only takes effect at next round</a>
<a name="410"><span class="lineNum">     410 </span>                :            :     /// @param _validatorAddress Address of the validator</a>
<a name="411"><span class="lineNum">     411 </span>                :            :     /// @param _minAutoshipAmount Amount desired before autoship kicks in</a>
<a name="412"><span class="lineNum">     412 </span>                :            :     /// @param _validatorPayableAddress Address the auction proceeds will go to for this validator</a>
<a name="413"><span class="lineNum">     413 </span>                :            :     function enableValidatorAddressWithPreferences(address _validatorAddress, uint128 _minAutoshipAmount, address _validatorPayableAddress) </a>
<a name="414"><span class="lineNum">     414 </span>                :            :         external</a>
<a name="415"><span class="lineNum">     415 </span>                :            :         onlyOwner</a>
<a name="416"><span class="lineNum">     416 </span>                :            :     {</a>
<a name="417"><span class="lineNum">     417 </span>                :<span class="lineCov">          7 :             _enableValidatorCheckpoint(_validatorAddress);</span></a>
<a name="418"><span class="lineNum">     418 </span>                :<span class="lineCov">          7 :             _updateValidatorPreferences(_validatorAddress, _minAutoshipAmount, _validatorPayableAddress);</span></a>
<a name="419"><span class="lineNum">     419 </span>                :            :     }</a>
<a name="420"><span class="lineNum">     420 </span>                :            : </a>
<a name="421"><span class="lineNum">     421 </span>                :            :     /// @notice Disables a validator</a>
<a name="422"><span class="lineNum">     422 </span>                :            :     /// @dev If auction is live, only takes effect at next round</a>
<a name="423"><span class="lineNum">     423 </span>                :            :     /// @param _validatorAddress Address of the validator</a>
<a name="424"><span class="lineNum">     424 </span>                :            :     function disableValidatorAddress(address _validatorAddress)</a>
<a name="425"><span class="lineNum">     425 </span>                :            :         external</a>
<a name="426"><span class="lineNum">     426 </span>                :            :         onlyOwner</a>
<a name="427"><span class="lineNum">     427 </span>                :            :     {</a>
<a name="428"><span class="lineNum">     428 </span>                :<span class="lineCov">          2 :         Status storage existingStatus = statusMap[_validatorAddress];</span></a>
<a name="429"><span class="lineNum">     429 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">          2 :         if (existingStatus.kind != statusType.VALIDATOR) revert PermissionMustBeValidator();</span></a>
<a name="430"><span class="lineNum">     430 </span>                :<span class="lineCov">          1 :         uint128 target_auction_number = auction_live ? auction_number + 1 : auction_number;</span></a>
<a name="431"><span class="lineNum">     431 </span>                :            : </a>
<a name="432"><span class="lineNum">     432 </span>                :<span class="lineCov">          1 :         existingStatus.inactiveAtAuctionRound = target_auction_number;</span></a>
<a name="433"><span class="lineNum">     433 </span>                :<span class="lineCov">          1 :         emit ValidatorAddressDisabled(_validatorAddress, target_auction_number);</span></a>
<a name="434"><span class="lineNum">     434 </span>                :            :     }</a>
<a name="435"><span class="lineNum">     435 </span>                :            : </a>
<a name="436"><span class="lineNum">     436 </span>                :            :     /// @notice Start auction round / Enable bidding</a>
<a name="437"><span class="lineNum">     437 </span>                :            :     /// @dev Both starter and owner roles are allowed to start</a>
<a name="438"><span class="lineNum">     438 </span>                :            :     function startAuction() external onlyStarterOrOwner notLiveStage {</a>
<a name="439"><span class="lineNum">     439 </span>                :<span class="lineCov">         28 :         auction_live = true;</span></a>
<a name="440"><span class="lineNum">     440 </span>                :<span class="lineCov">         28 :         emit AuctionStarted(auction_number);</span></a>
<a name="441"><span class="lineNum">     441 </span>                :            :     }</a>
<a name="442"><span class="lineNum">     442 </span>                :            : </a>
<a name="443"><span class="lineNum">     443 </span>                :            :     /// @notice Ends an auction round</a>
<a name="444"><span class="lineNum">     444 </span>                :            :     /// @dev Ending an auction round transfers the cuts to PFL and enables validators to collect theirs from the auction that ended</a>
<a name="445"><span class="lineNum">     445 </span>                :            :     /// @dev Also enables fastlane privileges of pairs winners until endAuction gets called again at next auction round</a>
<a name="446"><span class="lineNum">     446 </span>                :            :     function endAuction()</a>
<a name="447"><span class="lineNum">     447 </span>                :            :         external</a>
<a name="448"><span class="lineNum">     448 </span>                :            :         onlyStarterOrOwner</a>
<a name="449"><span class="lineNum">     449 </span>                :            :         atLiveStage</a>
<a name="450"><span class="lineNum">     450 </span>                :            :         nonReentrant</a>
<a name="451"><span class="lineNum">     451 </span>                :            :         returns (bool)</a>
<a name="452"><span class="lineNum">     452 </span>                :            :     {</a>
<a name="453"><span class="lineNum">     453 </span>                :            : </a>
<a name="454"><span class="lineNum">     454 </span>                :<span class="lineCov">         21 :         auction_live = false;</span></a>
<a name="455"><span class="lineNum">     455 </span>                :            : </a>
<a name="456"><span class="lineNum">     456 </span>                :<span class="lineCov">         21 :         emit AuctionEnded(auction_number);</span></a>
<a name="457"><span class="lineNum">     457 </span>                :            : </a>
<a name="458"><span class="lineNum">     458 </span>                :            :         // Increment auction_number so the checkpoints are available.</a>
<a name="459"><span class="lineNum">     459 </span>                :<span class="lineCov">         21 :         ++auction_number;</span></a>
<a name="460"><span class="lineNum">     460 </span>                :            : </a>
<a name="461"><span class="lineNum">     461 </span>                :<span class="lineCov">         21 :         uint256 ownerBalance = outstandingFLBalance;</span></a>
<a name="462"><span class="lineNum">     462 </span>                :<span class="lineCov">         21 :         outstandingFLBalance = 0;</span></a>
<a name="463"><span class="lineNum">     463 </span>                :            : </a>
<a name="464"><span class="lineNum">     464 </span>                :            :         // Last for C-E-I.</a>
<a name="465"><span class="lineNum">     465 </span>                :<span class="lineCov">         21 :         bid_token.safeTransfer(owner(), ownerBalance);</span></a>
<a name="466"><span class="lineNum">     466 </span>                :            : </a>
<a name="467"><span class="lineNum">     467 </span>                :<span class="lineCov">         21 :         return true;</span></a>
<a name="468"><span class="lineNum">     468 </span>                :            :     }</a>
<a name="469"><span class="lineNum">     469 </span>                :            : </a>
<a name="470"><span class="lineNum">     470 </span>                :            :     /// @notice Sets autopay batch size</a>
<a name="471"><span class="lineNum">     471 </span>                :            :     /// @dev Defines the maximum number of addresses the ops will try to pay outstanding balances per block</a>
<a name="472"><span class="lineNum">     472 </span>                :            :     /// @param _size Size of the batch</a>
<a name="473"><span class="lineNum">     473 </span>                :            :     function setAutopayBatchSize(uint16 _size) public onlyOwner {</a>
<a name="474"><span class="lineNum">     474 </span>                :<span class="lineCov">          4 :         autopay_batch_size = _size;</span></a>
<a name="475"><span class="lineNum">     475 </span>                :<span class="lineCov">          4 :         emit AutopayBatchSizeSet(autopay_batch_size);</span></a>
<a name="476"><span class="lineNum">     476 </span>                :            :     }</a>
<a name="477"><span class="lineNum">     477 </span>                :            : </a>
<a name="478"><span class="lineNum">     478 </span>                :            :     /// @notice Defines if the offchain checked is disabled</a>
<a name="479"><span class="lineNum">     479 </span>                :            :     /// @dev If true autoship will be disabled</a>
<a name="480"><span class="lineNum">     480 </span>                :            :     /// @param _state Disabled state</a>
<a name="481"><span class="lineNum">     481 </span>                :            :     function setOffchainCheckerDisabledState(bool _state) external onlyOwner {</a>
<a name="482"><span class="lineNum">     482 </span>                :<span class="lineCov">          2 :         _offchain_checker_disabled = _state;</span></a>
<a name="483"><span class="lineNum">     483 </span>                :            :     }</a>
<a name="484"><span class="lineNum">     484 </span>                :            : </a>
<a name="485"><span class="lineNum">     485 </span>                :            :     /// @notice Withdraws stuck matic</a>
<a name="486"><span class="lineNum">     486 </span>                :            :     /// @dev In the event people send matic instead of WMATIC we can send it back </a>
<a name="487"><span class="lineNum">     487 </span>                :            :     /// @param _amount Amount to send to owner</a>
<a name="488"><span class="lineNum">     488 </span>                :            :     function withdrawStuckNativeToken(uint256 _amount)</a>
<a name="489"><span class="lineNum">     489 </span>                :            :         external</a>
<a name="490"><span class="lineNum">     490 </span>                :            :         onlyOwner</a>
<a name="491"><span class="lineNum">     491 </span>                :            :         nonReentrant</a>
<a name="492"><span class="lineNum">     492 </span>                :            :     {</a>
<a name="493"><span class="lineNum">     493 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          1 :         if (address(this).balance &gt;= _amount) {</span></a>
<a name="494"><span class="lineNum">     494 </span>                :<span class="lineCov">          1 :             payable(owner()).sendValue(_amount);</span></a>
<a name="495"><span class="lineNum">     495 </span>                :<span class="lineCov">          1 :             emit WithdrawStuckNativeToken(owner(), _amount);</span></a>
<a name="496"><span class="lineNum">     496 </span>                :            :         }</a>
<a name="497"><span class="lineNum">     497 </span>                :            :     }</a>
<a name="498"><span class="lineNum">     498 </span>                :            : </a>
<a name="499"><span class="lineNum">     499 </span>                :            :     /// @notice Withdraws stuck ERC20</a>
<a name="500"><span class="lineNum">     500 </span>                :            :     /// @dev In the event people send ERC20 instead of bid_token ERC20 we can send them back </a>
<a name="501"><span class="lineNum">     501 </span>                :            :     /// @param _tokenAddress Address of the stuck token</a>
<a name="502"><span class="lineNum">     502 </span>                :            :     function withdrawStuckERC20(address _tokenAddress)</a>
<a name="503"><span class="lineNum">     503 </span>                :            :         external</a>
<a name="504"><span class="lineNum">     504 </span>                :            :         onlyOwner</a>
<a name="505"><span class="lineNum">     505 </span>                :            :         nonReentrant</a>
<a name="506"><span class="lineNum">     506 </span>                :            :     {</a>
<a name="507"><span class="lineNum">     507 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          2 :         if (_tokenAddress == address(bid_token)) revert InequalityWrongToken();</span></a>
<a name="508"><span class="lineNum">     508 </span>                :<span class="lineCov">          1 :         ERC20 oopsToken = ERC20(_tokenAddress);</span></a>
<a name="509"><span class="lineNum">     509 </span>                :<span class="lineCov">          1 :         uint256 oopsTokenBalance = oopsToken.balanceOf(address(this));</span></a>
<a name="510"><span class="lineNum">     510 </span>                :            : </a>
<a name="511"><span class="lineNum">     511 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          1 :         if (oopsTokenBalance &gt; 0) {</span></a>
<a name="512"><span class="lineNum">     512 </span>                :<span class="lineCov">          1 :             oopsToken.safeTransfer(owner(), oopsTokenBalance);</span></a>
<a name="513"><span class="lineNum">     513 </span>                :<span class="lineCov">          1 :             emit WithdrawStuckERC20(address(this), owner(), oopsTokenBalance);</span></a>
<a name="514"><span class="lineNum">     514 </span>                :            :         }</a>
<a name="515"><span class="lineNum">     515 </span>                :            :     }</a>
<a name="516"><span class="lineNum">     516 </span>                :            : </a>
<a name="517"><span class="lineNum">     517 </span>                :            :     /// @notice Internal, receives a bid</a>
<a name="518"><span class="lineNum">     518 </span>                :            :     /// @dev Requires approval of this contract beforehands</a>
<a name="519"><span class="lineNum">     519 </span>                :            :     /// @param _currentTopBidAmount Value of the current top bid</a>
<a name="520"><span class="lineNum">     520 </span>                :            :     /// @param _currentTopBidSearcherPayableAddress Address of the current top bidder for that bid pair</a>
<a name="521"><span class="lineNum">     521 </span>                :            :     function _receiveBid(</a>
<a name="522"><span class="lineNum">     522 </span>                :            :         Bid memory bid,</a>
<a name="523"><span class="lineNum">     523 </span>                :            :         uint256 _currentTopBidAmount,</a>
<a name="524"><span class="lineNum">     524 </span>                :            :         address _currentTopBidSearcherPayableAddress</a>
<a name="525"><span class="lineNum">     525 </span>                :            :     ) internal {</a>
<a name="526"><span class="lineNum">     526 </span>                :            :         // Verify the bid exceeds previous bid + minimum increment</a>
<a name="527"><span class="lineNum">     527 </span>        [<span class="branchCov" title="Branch 0 was taken 4 times"> + </span><span class="branchCov" title="Branch 1 was taken 28 times"> + </span>]:<span class="lineCov">         32 :         if (bid.bidAmount &lt; _currentTopBidAmount + bid_increment) revert InequalityTooLow();</span></a>
<a name="528"><span class="lineNum">     528 </span>                :            : </a>
<a name="529"><span class="lineNum">     529 </span>                :            :         // Verify the new bidder isnt the previous bidder as self-spam protection</a>
<a name="530"><span class="lineNum">     530 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 27 times"> + </span>]:<span class="lineCov">         28 :         if (bid.searcherPayableAddress == _currentTopBidSearcherPayableAddress) revert InequalityAlreadyTopBidder();</span></a>
<a name="531"><span class="lineNum">     531 </span>                :            : </a>
<a name="532"><span class="lineNum">     532 </span>                :            :         // Verify the bidder has the balance.</a>
<a name="533"><span class="lineNum">     533 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchCov" title="Branch 1 was taken 27 times"> + </span>]:<span class="lineCov">         27 :         if (bid_token.balanceOf(bid.searcherPayableAddress) &lt; bid.bidAmount) revert InequalityNotEnoughFunds();</span></a>
<a name="534"><span class="lineNum">     534 </span>                :            : </a>
<a name="535"><span class="lineNum">     535 </span>                :            :         // Transfer the bid amount (requires approval)</a>
<a name="536"><span class="lineNum">     536 </span>                :<span class="lineCov">         26 :         bid_token.safeTransferFrom(</span></a>
<a name="537"><span class="lineNum">     537 </span>                :            :             bid.searcherPayableAddress,</a>
<a name="538"><span class="lineNum">     538 </span>                :            :             address(this),</a>
<a name="539"><span class="lineNum">     539 </span>                :            :             bid.bidAmount</a>
<a name="540"><span class="lineNum">     540 </span>                :            :         );</a>
<a name="541"><span class="lineNum">     541 </span>                :            :     }</a>
<a name="542"><span class="lineNum">     542 </span>                :            : </a>
<a name="543"><span class="lineNum">     543 </span>                :            :     /// @notice Internal, refunds previous top bidder</a>
<a name="544"><span class="lineNum">     544 </span>                :            :     /// @dev Be very careful about changing bid token to any ERC777</a>
<a name="545"><span class="lineNum">     545 </span>                :            :     /// @param bid Bid to refund</a>
<a name="546"><span class="lineNum">     546 </span>                :            :     function _refundPreviousBidder(Bid memory bid) internal {</a>
<a name="547"><span class="lineNum">     547 </span>                :<span class="lineCov">          5 :         bid_token.safeTransfer(</span></a>
<a name="548"><span class="lineNum">     548 </span>                :            :             bid.searcherPayableAddress,</a>
<a name="549"><span class="lineNum">     549 </span>                :            :             bid.bidAmount</a>
<a name="550"><span class="lineNum">     550 </span>                :            :         );</a>
<a name="551"><span class="lineNum">     551 </span>                :            :     }</a>
<a name="552"><span class="lineNum">     552 </span>                :            : </a>
<a name="553"><span class="lineNum">     553 </span>                :            :     /// @notice Internal, calculates cuts</a>
<a name="554"><span class="lineNum">     554 </span>                :            :     /// @dev vCut </a>
<a name="555"><span class="lineNum">     555 </span>                :            :     /// @param amount Amount to calculates cuts from</a>
<a name="556"><span class="lineNum">     556 </span>                :            :     /// @return vCut validator cut</a>
<a name="557"><span class="lineNum">     557 </span>                :            :     /// @return flCut protocol cut</a>
<a name="558"><span class="lineNum">     558 </span>                :            :     function _calculateCuts(uint256 amount) internal view returns (uint256 vCut, uint256 flCut) {</a>
<a name="559"><span class="lineNum">     559 </span>                :<span class="lineCov">         41 :         vCut = (amount * (1000000 - fast_lane_fee)) / 1000000;</span></a>
<a name="560"><span class="lineNum">     560 </span>                :<span class="lineCov">         41 :         flCut = amount - vCut;</span></a>
<a name="561"><span class="lineNum">     561 </span>                :            :     }</a>
<a name="562"><span class="lineNum">     562 </span>                :            : </a>
<a name="563"><span class="lineNum">     563 </span>                :            :     /// @notice Internal, calculates if a validator balance checkpoint is redeemable as of current auction_number against a certain amount</a>
<a name="564"><span class="lineNum">     564 </span>                :            :     /// @dev Not pure, depends of global auction_number, could be only outstandingBalance or outstandingBalance + pendingBalanceAtlastBid if last bid was at an oldest round than auction_number</a>
<a name="565"><span class="lineNum">     565 </span>                :            :     /// @param valCheckpoint Validator checkpoint to validate against `minAmount`</a>
<a name="566"><span class="lineNum">     566 </span>                :            :     /// @param minAmount Amount to calculates cuts from</a>
<a name="567"><span class="lineNum">     567 </span>                :            :     /// @return bool Is there balance to redeem for validator and amount at current auction_number</a>
<a name="568"><span class="lineNum">     568 </span>                :            :     function _checkRedeemableOutstanding(ValidatorBalanceCheckpoint memory valCheckpoint,uint256 minAmount) internal view returns (bool) {</a>
<a name="569"><span class="lineNum">     569 </span>                :<span class="lineCov">         47 :         return valCheckpoint.outstandingBalance &gt;= minAmount || ((valCheckpoint.lastBidReceivedAuction &lt; auction_number) &amp;&amp; ((valCheckpoint.pendingBalanceAtlastBid + valCheckpoint.outstandingBalance) &gt;= minAmount));    </span></a>
<a name="570"><span class="lineNum">     570 </span>                :            :     }</a>
<a name="571"><span class="lineNum">     571 </span>                :            : </a>
<a name="572"><span class="lineNum">     572 </span>                :            :     /// @notice Internal, attemps to redeem a validator outstanding balance to its validatorPayableAddress</a>
<a name="573"><span class="lineNum">     573 </span>                :            :     /// @dev Must be owed at least 1 of `bid_token`</a>
<a name="574"><span class="lineNum">     574 </span>                :            :     /// @param _outstandingValidatorWithBalance Validator address</a>
<a name="575"><span class="lineNum">     575 </span>                :            :     function _redeemOutstanding(address _outstandingValidatorWithBalance) internal {</a>
<a name="576"><span class="lineNum">     576 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchCov" title="Branch 1 was taken 16 times"> + </span>]:<span class="lineCov">         16 :         if (statusMap[_outstandingValidatorWithBalance].kind != statusType.VALIDATOR) revert PermissionMustBeValidator();</span></a>
<a name="577"><span class="lineNum">     577 </span>                :<span class="lineCov">         15 :         ValidatorBalanceCheckpoint storage valCheckpoint = validatorsCheckpoints[_outstandingValidatorWithBalance];</span></a>
<a name="578"><span class="lineNum">     578 </span>                :            :        </a>
<a name="579"><span class="lineNum">     579 </span>                :            :         // Either we have outstandingBalance or we have pendingBalanceAtlastBid from previous auctions.</a>
<a name="580"><span class="lineNum">     580 </span>        [<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchCov" title="Branch 1 was taken 12 times"> + </span>]:<span class="lineCov">         15 :         if (!_checkRedeemableOutstanding(valCheckpoint, 1)) revert InequalityNothingToRedeem();</span></a>
<a name="581"><span class="lineNum">     581 </span>                :            : </a>
<a name="582"><span class="lineNum">     582 </span>                :<span class="lineCov">         12 :         uint256 redeemable = 0;</span></a>
<a name="583"><span class="lineNum">     583 </span>        [<span class="branchCov" title="Branch 0 was taken 10 times"> + </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">         12 :         if (valCheckpoint.lastBidReceivedAuction &lt; auction_number) {</span></a>
<a name="584"><span class="lineNum">     584 </span>                :            :             // We can redeem both</a>
<a name="585"><span class="lineNum">     585 </span>                :<span class="lineCov">         10 :             redeemable = valCheckpoint.pendingBalanceAtlastBid + valCheckpoint.outstandingBalance;</span></a>
<a name="586"><span class="lineNum">     586 </span>                :<span class="lineCov">         10 :             valCheckpoint.pendingBalanceAtlastBid = 0;</span></a>
<a name="587"><span class="lineNum">     587 </span>                :            :         } else {</a>
<a name="588"><span class="lineNum">     588 </span>                :            :             // Another bid was received in the current auction, profits were already moved</a>
<a name="589"><span class="lineNum">     589 </span>                :            :             // to outstandingBalance by the bidder</a>
<a name="590"><span class="lineNum">     590 </span>                :<span class="lineCov">          2 :             redeemable = valCheckpoint.outstandingBalance;</span></a>
<a name="591"><span class="lineNum">     591 </span>                :            :         }</a>
<a name="592"><span class="lineNum">     592 </span>                :            : </a>
<a name="593"><span class="lineNum">     593 </span>                :            :         // Clear outstanding in any case.</a>
<a name="594"><span class="lineNum">     594 </span>                :<span class="lineCov">         12 :         valCheckpoint.outstandingBalance = 0;</span></a>
<a name="595"><span class="lineNum">     595 </span>                :<span class="lineCov">         12 :         valCheckpoint.lastWithdrawnAuction = auction_number;</span></a>
<a name="596"><span class="lineNum">     596 </span>                :            : </a>
<a name="597"><span class="lineNum">     597 </span>                :<span class="lineCov">         12 :         address dst = _outstandingValidatorWithBalance;</span></a>
<a name="598"><span class="lineNum">     598 </span>                :<span class="lineCov">         12 :         ValidatorPreferences memory valPrefs = validatorsPreferences[dst];</span></a>
<a name="599"><span class="lineNum">     599 </span>        [<span class="branchCov" title="Branch 0 was taken 5 times"> + </span><span class="branchCov" title="Branch 1 was taken 12 times"> + </span>]:<span class="lineCov">         12 :         if (valPrefs.validatorPayableAddress != address(0)) {</span></a>
<a name="600"><span class="lineNum">     600 </span>                :<span class="lineCov">          5 :             dst = valPrefs.validatorPayableAddress;</span></a>
<a name="601"><span class="lineNum">     601 </span>                :            :         }</a>
<a name="602"><span class="lineNum">     602 </span>                :            : </a>
<a name="603"><span class="lineNum">     603 </span>                :<span class="lineCov">         12 :         bid_token.safeTransfer(</span></a>
<a name="604"><span class="lineNum">     604 </span>                :            :             dst,</a>
<a name="605"><span class="lineNum">     605 </span>                :            :             redeemable</a>
<a name="606"><span class="lineNum">     606 </span>                :            :         );</a>
<a name="607"><span class="lineNum">     607 </span>                :            : </a>
<a name="608"><span class="lineNum">     608 </span>                :<span class="lineCov">         12 :         emit ValidatorWithdrawnBalance(</span></a>
<a name="609"><span class="lineNum">     609 </span>                :            :             _outstandingValidatorWithBalance,</a>
<a name="610"><span class="lineNum">     610 </span>                :            :             auction_number,</a>
<a name="611"><span class="lineNum">     611 </span>                :            :             redeemable,</a>
<a name="612"><span class="lineNum">     612 </span>                :            :             dst,</a>
<a name="613"><span class="lineNum">     613 </span>                :            :             msg.sender</a>
<a name="614"><span class="lineNum">     614 </span>                :            :         );</a>
<a name="615"><span class="lineNum">     615 </span>                :            :     }</a>
<a name="616"><span class="lineNum">     616 </span>                :            : </a>
<a name="617"><span class="lineNum">     617 </span>                :            :     /***********************************|</a>
<a name="618"><span class="lineNum">     618 </span>                :            :     |             Public                |</a>
<a name="619"><span class="lineNum">     619 </span>                :            :     |__________________________________*/</a>
<a name="620"><span class="lineNum">     620 </span>                :            : </a>
<a name="621"><span class="lineNum">     621 </span>                :            : </a>
<a name="622"><span class="lineNum">     622 </span>                :            :     /// @notice Bidding function for searchers to submit their bids</a>
<a name="623"><span class="lineNum">     623 </span>                :            :     /// @dev Each bid pulls funds on submission and searchers are refunded when they are outbid</a>
<a name="624"><span class="lineNum">     624 </span>                :            :     /// @param bid Bid struct as tuple (validatorAddress, opportunityAddress, searcherContractAddress ,searcherPayableAddress, bidAmount)</a>
<a name="625"><span class="lineNum">     625 </span>                :            :     function submitBid(Bid calldata bid)</a>
<a name="626"><span class="lineNum">     626 </span>                :            :         external</a>
<a name="627"><span class="lineNum">     627 </span>                :            :         atLiveStage</a>
<a name="628"><span class="lineNum">     628 </span>                :            :         whenNotPaused</a>
<a name="629"><span class="lineNum">     629 </span>                :            :         nonReentrant</a>
<a name="630"><span class="lineNum">     630 </span>                :            :     {</a>
<a name="631"><span class="lineNum">     631 </span>                :            :         // Verify that the bid is coming from the EOA that's paying</a>
<a name="632"><span class="lineNum">     632 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 39 times"> + </span>]:<span class="lineCov">         40 :         if (msg.sender != bid.searcherPayableAddress) revert PermissionOnlyFromPayorEoa();</span></a>
<a name="633"><span class="lineNum">     633 </span>                :            : </a>
<a name="634"><span class="lineNum">     634 </span>                :<span class="lineCov">         39 :         Status memory validatorStatus = statusMap[bid.validatorAddress];</span></a>
<a name="635"><span class="lineNum">     635 </span>                :<span class="lineCov">         39 :         Status memory opportunityStatus = statusMap[bid.opportunityAddress];</span></a>
<a name="636"><span class="lineNum">     636 </span>                :            : </a>
<a name="637"><span class="lineNum">     637 </span>                :            :         // Verify that the opportunity and the validator are both participating addresses</a>
<a name="638"><span class="lineNum">     638 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchCov" title="Branch 1 was taken 39 times"> + </span>]:<span class="lineCov">         39 :         if (validatorStatus.kind != statusType.VALIDATOR) revert PermissionMustBeValidator();</span></a>
<a name="639"><span class="lineNum">     639 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchCov" title="Branch 1 was taken 38 times"> + </span>]:<span class="lineCov">         38 :         if (opportunityStatus.kind != statusType.OPPORTUNITY) revert PermissionInvalidOpportunityAddress();</span></a>
<a name="640"><span class="lineNum">     640 </span>                :            : </a>
<a name="641"><span class="lineNum">     641 </span>                :            :         // We want auction_number be in the [activeAtAuctionRound - inactiveAtAuctionRound] window.</a>
<a name="642"><span class="lineNum">     642 </span>                :            :         // Verify not flagged as inactive</a>
<a name="643"><span class="lineNum">     643 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 35 times"> + </span>]:<span class="lineCov">         37 :         if (validatorStatus.inactiveAtAuctionRound &lt;= auction_number) revert InequalityValidatorDisabledAtTime();</span></a>
<a name="644"><span class="lineNum">     644 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 34 times"> + </span>]:<span class="lineCov">         35 :         if (opportunityStatus.inactiveAtAuctionRound &lt;= auction_number) revert InequalityOpportunityDisabledAtTime();</span></a>
<a name="645"><span class="lineNum">     645 </span>                :            : </a>
<a name="646"><span class="lineNum">     646 </span>                :            :         // Verify still flagged active</a>
<a name="647"><span class="lineNum">     647 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 33 times"> + </span>]:<span class="lineCov">         34 :         if (validatorStatus.activeAtAuctionRound &gt; auction_number) revert InequalityValidatorNotEnabledYet();</span></a>
<a name="648"><span class="lineNum">     648 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 32 times"> + </span>]:<span class="lineCov">         33 :         if (opportunityStatus.activeAtAuctionRound &gt; auction_number) revert InequalityOpportunityNotEnabledYet();</span></a>
<a name="649"><span class="lineNum">     649 </span>                :            : </a>
<a name="650"><span class="lineNum">     650 </span>                :            : </a>
<a name="651"><span class="lineNum">     651 </span>                :            :         // Figure out if we have an existing bid </a>
<a name="652"><span class="lineNum">     652 </span>                :<span class="lineCov">         32 :         Bid memory current_top_bid = auctionsMap[auction_number][</span></a>
<a name="653"><span class="lineNum">     653 </span>                :            :                 bid.validatorAddress</a>
<a name="654"><span class="lineNum">     654 </span>                :            :             ][bid.opportunityAddress];</a>
<a name="655"><span class="lineNum">     655 </span>                :            : </a>
<a name="656"><span class="lineNum">     656 </span>                :<span class="lineCov">         32 :         ValidatorBalanceCheckpoint storage valCheckpoint = validatorsCheckpoints[bid.validatorAddress];</span></a>
<a name="657"><span class="lineNum">     657 </span>                :            : </a>
<a name="658"><span class="lineNum">     658 </span>        [<span class="branchCov" title="Branch 0 was taken 23 times"> + </span><span class="branchCov" title="Branch 1 was taken 32 times"> + </span>]:<span class="lineCov">         32 :         if ((valCheckpoint.lastBidReceivedAuction != auction_number) &amp;&amp; (valCheckpoint.pendingBalanceAtlastBid &gt; 0)) {</span></a>
<a name="659"><span class="lineNum">     659 </span>                :            :             // Need to move pending to outstanding</a>
<a name="660"><span class="lineNum">     660 </span>                :<span class="lineCov">          4 :             valCheckpoint.outstandingBalance += valCheckpoint.pendingBalanceAtlastBid;</span></a>
<a name="661"><span class="lineNum">     661 </span>                :<span class="lineCov">          4 :             valCheckpoint.pendingBalanceAtlastBid = 0;</span></a>
<a name="662"><span class="lineNum">     662 </span>                :            :         }</a>
<a name="663"><span class="lineNum">     663 </span>                :            :  </a>
<a name="664"><span class="lineNum">     664 </span>                :            :         // Update bid for pair</a>
<a name="665"><span class="lineNum">     665 </span>                :<span class="lineCov">         32 :         auctionsMap[auction_number][bid.validatorAddress][</span></a>
<a name="666"><span class="lineNum">     666 </span>                :            :                 bid.opportunityAddress</a>
<a name="667"><span class="lineNum">     667 </span>                :            :             ] = bid;</a>
<a name="668"><span class="lineNum">     668 </span>                :            : </a>
<a name="669"><span class="lineNum">     669 </span>        [<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchCov" title="Branch 1 was taken 23 times"> + </span>]:<span class="lineCov">         32 :         if (current_top_bid.bidAmount &gt; 0) {</span></a>
<a name="670"><span class="lineNum">     670 </span>                :            :             // Existing bid for this auction number &amp;&amp; pair combo</a>
<a name="671"><span class="lineNum">     671 </span>                :            :             // Handle checkpoint cuts replacement</a>
<a name="672"><span class="lineNum">     672 </span>                :<span class="lineCov">          9 :             (uint256 vCutPrevious, uint256 flCutPrevious) = _calculateCuts(current_top_bid.bidAmount);</span></a>
<a name="673"><span class="lineNum">     673 </span>                :<span class="lineCov">          9 :             (uint256 vCut, uint256 flCut) = _calculateCuts(bid.bidAmount);</span></a>
<a name="674"><span class="lineNum">     674 </span>                :            : </a>
<a name="675"><span class="lineNum">     675 </span>                :<span class="lineCov">          9 :             outstandingFLBalance = outstandingFLBalance + flCut - flCutPrevious;</span></a>
<a name="676"><span class="lineNum">     676 </span>                :<span class="lineCov">          9 :             valCheckpoint.pendingBalanceAtlastBid =  valCheckpoint.pendingBalanceAtlastBid + vCut - vCutPrevious;</span></a>
<a name="677"><span class="lineNum">     677 </span>                :            : </a>
<a name="678"><span class="lineNum">     678 </span>                :            : </a>
<a name="679"><span class="lineNum">     679 </span>                :            :             // Update the existing Bid mapping</a>
<a name="680"><span class="lineNum">     680 </span>                :<span class="lineCov">          9 :             _receiveBid(</span></a>
<a name="681"><span class="lineNum">     681 </span>                :            :                 bid,</a>
<a name="682"><span class="lineNum">     682 </span>                :            :                 current_top_bid.bidAmount,</a>
<a name="683"><span class="lineNum">     683 </span>                :            :                 current_top_bid.searcherPayableAddress</a>
<a name="684"><span class="lineNum">     684 </span>                :            :             );</a>
<a name="685"><span class="lineNum">     685 </span>                :<span class="lineCov">          5 :             _refundPreviousBidder(current_top_bid);</span></a>
<a name="686"><span class="lineNum">     686 </span>                :            : </a>
<a name="687"><span class="lineNum">     687 </span>                :            :            </a>
<a name="688"><span class="lineNum">     688 </span>                :            :         } else {</a>
<a name="689"><span class="lineNum">     689 </span>                :            :             // First bid on pair for this auction number</a>
<a name="690"><span class="lineNum">     690 </span>                :            :             // Update checkpoint if needed as another pair could have bid already for this auction number</a>
<a name="691"><span class="lineNum">     691 </span>                :            :             </a>
<a name="692"><span class="lineNum">     692 </span>        [<span class="branchCov" title="Branch 0 was taken 23 times"> + </span><span class="branchCov" title="Branch 1 was taken 23 times"> + </span>]:<span class="lineCov">         23 :             if (valCheckpoint.lastBidReceivedAuction != auction_number) {</span></a>
<a name="693"><span class="lineNum">     693 </span>                :<span class="lineCov">         23 :                 valCheckpoint.lastBidReceivedAuction = auction_number;</span></a>
<a name="694"><span class="lineNum">     694 </span>                :            :             }</a>
<a name="695"><span class="lineNum">     695 </span>                :            : </a>
<a name="696"><span class="lineNum">     696 </span>                :<span class="lineCov">         23 :             (uint256 vCutFirst, uint256 flCutFirst) = _calculateCuts(bid.bidAmount);</span></a>
<a name="697"><span class="lineNum">     697 </span>                :            : </a>
<a name="698"><span class="lineNum">     698 </span>                :            :             // Handle cuts</a>
<a name="699"><span class="lineNum">     699 </span>                :<span class="lineCov">         23 :             outstandingFLBalance += flCutFirst;</span></a>
<a name="700"><span class="lineNum">     700 </span>                :<span class="lineCov">         23 :             valCheckpoint.pendingBalanceAtlastBid += vCutFirst;</span></a>
<a name="701"><span class="lineNum">     701 </span>                :            : </a>
<a name="702"><span class="lineNum">     702 </span>                :            :              // Check balance</a>
<a name="703"><span class="lineNum">     703 </span>                :<span class="lineCov">         23 :             _receiveBid(bid, 0, address(0));</span></a>
<a name="704"><span class="lineNum">     704 </span>                :            :             </a>
<a name="705"><span class="lineNum">     705 </span>                :            : </a>
<a name="706"><span class="lineNum">     706 </span>                :            :         }</a>
<a name="707"><span class="lineNum">     707 </span>                :            : </a>
<a name="708"><span class="lineNum">     708 </span>                :            :         // Try adding to the validatorsactiveAtAuctionRound so the keeper can loop on it</a>
<a name="709"><span class="lineNum">     709 </span>                :            :         // EnumerableSet already checks key pre-existence</a>
<a name="710"><span class="lineNum">     710 </span>                :<span class="lineCov">         25 :         validatorsactiveAtAuctionRound[auction_number].add(bid.validatorAddress);</span></a>
<a name="711"><span class="lineNum">     711 </span>                :            : </a>
<a name="712"><span class="lineNum">     712 </span>                :<span class="lineCov">         25 :         emit BidAdded(</span></a>
<a name="713"><span class="lineNum">     713 </span>                :            :             bid.searcherContractAddress,</a>
<a name="714"><span class="lineNum">     714 </span>                :            :             bid.validatorAddress,</a>
<a name="715"><span class="lineNum">     715 </span>                :            :             bid.opportunityAddress,</a>
<a name="716"><span class="lineNum">     716 </span>                :            :             bid.bidAmount,</a>
<a name="717"><span class="lineNum">     717 </span>                :            :             auction_number</a>
<a name="718"><span class="lineNum">     718 </span>                :            :         );</a>
<a name="719"><span class="lineNum">     719 </span>                :            :     }</a>
<a name="720"><span class="lineNum">     720 </span>                :            : </a>
<a name="721"><span class="lineNum">     721 </span>                :            :     /// @notice Validators can always withdraw right after an amount is due</a>
<a name="722"><span class="lineNum">     722 </span>                :            :     /// @dev It can be during an ongoing auction with pendingBalanceAtlastBid being the current auction</a>
<a name="723"><span class="lineNum">     723 </span>                :            :     /// @dev Or lastBidReceivedAuction being a previous auction, in which case outstanding+pending can be withdrawn</a>
<a name="724"><span class="lineNum">     724 </span>                :            :     /// @dev _Anyone_ can initiate a validator to be paid what it's owed</a>
<a name="725"><span class="lineNum">     725 </span>                :            :     /// @param _outstandingValidatorWithBalance Redeems outstanding balance for a validator</a>
<a name="726"><span class="lineNum">     726 </span>                :            :     function redeemOutstandingBalance(address _outstandingValidatorWithBalance)</a>
<a name="727"><span class="lineNum">     727 </span>                :            :         external</a>
<a name="728"><span class="lineNum">     728 </span>                :            :         whenNotPaused</a>
<a name="729"><span class="lineNum">     729 </span>                :            :         nonReentrant</a>
<a name="730"><span class="lineNum">     730 </span>                :            :     {</a>
<a name="731"><span class="lineNum">     731 </span>                :<span class="lineCov">         11 :         _redeemOutstanding(_outstandingValidatorWithBalance);</span></a>
<a name="732"><span class="lineNum">     732 </span>                :            :     }</a>
<a name="733"><span class="lineNum">     733 </span>                :            : </a>
<a name="734"><span class="lineNum">     734 </span>                :            :     /***********************************|</a>
<a name="735"><span class="lineNum">     735 </span>                :            :     |       Public Resolvers            |</a>
<a name="736"><span class="lineNum">     736 </span>                :            :     |__________________________________*/</a>
<a name="737"><span class="lineNum">     737 </span>                :            : </a>
<a name="738"><span class="lineNum">     738 </span>                :            :     /// @notice Gelato Offchain Resolver</a>
<a name="739"><span class="lineNum">     739 </span>                :            :     /// @dev Automated function checked each block offchain by Gelato Network if there is outstanding payments to process</a>
<a name="740"><span class="lineNum">     740 </span>                :            :     /// @return canExec Should the worker trigger</a>
<a name="741"><span class="lineNum">     741 </span>                :            :     /// @return execPayload The payload if canExec is true</a>
<a name="742"><span class="lineNum">     742 </span>                :            :     function checker()</a>
<a name="743"><span class="lineNum">     743 </span>                :            :         external</a>
<a name="744"><span class="lineNum">     744 </span>                :            :         view</a>
<a name="745"><span class="lineNum">     745 </span>                :            :         returns (bool canExec, bytes memory execPayload)</a>
<a name="746"><span class="lineNum">     746 </span>                :            :     {</a>
<a name="747"><span class="lineNum">     747 </span>        [<span class="branchCov" title="Branch 0 was taken 16 times"> + </span><span class="branchCov" title="Branch 1 was taken 17 times"> + </span>]:<span class="lineCov">         17 :         if (_offchain_checker_disabled || paused  || tx.gasprice &gt; max_gas_price) return (false, &quot;&quot;);</span></a>
<a name="748"><span class="lineNum">     748 </span>                :            :             // Go workers go</a>
<a name="749"><span class="lineNum">     749 </span>                :<span class="lineCov">         15 :             canExec = false;</span></a>
<a name="750"><span class="lineNum">     750 </span>                :<span class="lineCov">         15 :             (</span></a>
<a name="751"><span class="lineNum">     751 </span>                :            :                 bool hasJobs,</a>
<a name="752"><span class="lineNum">     752 </span>                :            :                 address[] memory autopayRecipients</a>
<a name="753"><span class="lineNum">     753 </span>                :<span class="lineCov">         15 :             ) = getAutopayJobs(autopay_batch_size, auction_number - 1);</span></a>
<a name="754"><span class="lineNum">     754 </span>        [<span class="branchCov" title="Branch 0 was taken 5 times"> + </span><span class="branchCov" title="Branch 1 was taken 10 times"> + </span>]:<span class="lineCov">         15 :             if (hasJobs) {</span></a>
<a name="755"><span class="lineNum">     755 </span>                :<span class="lineCov">          5 :                 canExec = true;</span></a>
<a name="756"><span class="lineNum">     756 </span>                :<span class="lineCov">          5 :                 execPayload = abi.encodeWithSelector(</span></a>
<a name="757"><span class="lineNum">     757 </span>                :            :                     this.processAutopayJobs.selector,</a>
<a name="758"><span class="lineNum">     758 </span>                :            :                     autopayRecipients</a>
<a name="759"><span class="lineNum">     759 </span>                :            :                 );</a>
<a name="760"><span class="lineNum">     760 </span>                :<span class="lineCov">          5 :                 return (canExec, execPayload);</span></a>
<a name="761"><span class="lineNum">     761 </span>                :            :             }</a>
<a name="762"><span class="lineNum">     762 </span>                :<span class="lineCov">         10 :         return (false, &quot;&quot;);</span></a>
<a name="763"><span class="lineNum">     763 </span>                :            :     }</a>
<a name="764"><span class="lineNum">     764 </span>                :            : </a>
<a name="765"><span class="lineNum">     765 </span>                :            :     /// @notice Processes a list of addresses to transfer their outstanding balance</a>
<a name="766"><span class="lineNum">     766 </span>                :            :     /// @dev Genrally called by Ops with array length of autopay_batch_size</a>
<a name="767"><span class="lineNum">     767 </span>                :            :     /// @param autopayRecipients Array of recipents to consider for autopay</a>
<a name="768"><span class="lineNum">     768 </span>                :            :     function processAutopayJobs(address[] calldata autopayRecipients) external nonReentrant onlyOwnerStarterOps {</a>
<a name="769"><span class="lineNum">     769 </span>                :            :         // Reassert checks if insane spike between gelato trigger and tx picked up</a>
<a name="770"><span class="lineNum">     770 </span>        [<span class="branchCov" title="Branch 0 was taken 5 times"> + </span><span class="branchCov" title="Branch 1 was taken 5 times"> + </span>]:<span class="lineCov">          5 :         if (_offchain_checker_disabled || paused) revert PermissionPaused();</span></a>
<a name="771"><span class="lineNum">     771 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 4 times"> + </span>]:<span class="lineCov">          5 :         if (tx.gasprice &gt; max_gas_price) revert TimeGasNotSuitable();</span></a>
<a name="772"><span class="lineNum">     772 </span>                :            : </a>
<a name="773"><span class="lineNum">     773 </span>                :<span class="lineCov">          4 :         uint length = autopayRecipients.length;</span></a>
<a name="774"><span class="lineNum">     774 </span>                :<span class="lineCov">          4 :         for (uint i = 0;i &lt; length;) {</span></a>
<a name="775"><span class="lineNum">     775 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchCov" title="Branch 1 was taken 8 times"> + </span>]:<span class="lineCov">          8 :             if (autopayRecipients[i] != address(0)) {</span></a>
<a name="776"><span class="lineNum">     776 </span>                :<span class="lineCov">          5 :                 _redeemOutstanding(autopayRecipients[i]);</span></a>
<a name="777"><span class="lineNum">     777 </span>                :            :             }</a>
<a name="778"><span class="lineNum">     778 </span>                :<span class="lineCov">          8 :             unchecked { ++i; }</span></a>
<a name="779"><span class="lineNum">     779 </span>                :            :         }</a>
<a name="780"><span class="lineNum">     780 </span>                :            :     }</a>
<a name="781"><span class="lineNum">     781 </span>                :            : </a>
<a name="782"><span class="lineNum">     782 </span>                :            :     /***********************************|</a>
<a name="783"><span class="lineNum">     783 </span>                :            :     |             Views                 |</a>
<a name="784"><span class="lineNum">     784 </span>                :            :     |__________________________________*/</a>
<a name="785"><span class="lineNum">     785 </span>                :            : </a>
<a name="786"><span class="lineNum">     786 </span>                :            :     /// @notice Returns if there is autopays to be done for given `_auction_index`</a>
<a name="787"><span class="lineNum">     787 </span>                :            :     /// @dev  Most likely called off chain by Gelato</a>
<a name="788"><span class="lineNum">     788 </span>                :            :     /// @param _batch_size Max recipients to return</a>
<a name="789"><span class="lineNum">     789 </span>                :            :     /// @param _auction_index Auction round</a>
<a name="790"><span class="lineNum">     790 </span>                :            :     /// @return hasJobs If there was jobs found to be done by ops</a>
<a name="791"><span class="lineNum">     791 </span>                :            :     /// @return autopayRecipients List of addresses eligible to be paid</a>
<a name="792"><span class="lineNum">     792 </span>                :            :     function getAutopayJobs(uint16 _batch_size, uint128 _auction_index) public view returns (bool hasJobs, address[] memory autopayRecipients) {</a>
<a name="793"><span class="lineNum">     793 </span>                :<span class="lineCov">         22 :         autopayRecipients = new address[](_batch_size); // Filled with 0x0</span></a>
<a name="794"><span class="lineNum">     794 </span>                :            :         // An active validator means a bid happened so potentially balances were moved to outstanding while the bid happened</a>
<a name="795"><span class="lineNum">     795 </span>                :<span class="lineCov">         22 :         EnumerableSet.AddressSet storage prevRoundAddrSet = validatorsactiveAtAuctionRound[_auction_index];</span></a>
<a name="796"><span class="lineNum">     796 </span>                :<span class="lineCov">         22 :         uint16 assigned = 0;</span></a>
<a name="797"><span class="lineNum">     797 </span>                :<span class="lineCov">         22 :         uint256 len = prevRoundAddrSet.length();</span></a>
<a name="798"><span class="lineNum">     798 </span>                :<span class="lineCov">         22 :         for (uint256 i = 0; i &lt; len; i++) {</span></a>
<a name="799"><span class="lineNum">     799 </span>                :<span class="lineCov">         32 :             address current_validator = prevRoundAddrSet.at(i);</span></a>
<a name="800"><span class="lineNum">     800 </span>                :<span class="lineCov">         32 :             ValidatorBalanceCheckpoint memory valCheckpoint = validatorsCheckpoints[current_validator];</span></a>
<a name="801"><span class="lineNum">     801 </span>                :<span class="lineCov">         32 :             uint256 minAmountForValidator = minAutoShipThreshold &gt;= validatorsPreferences[current_validator].minAutoshipAmount ? minAutoShipThreshold : validatorsPreferences[current_validator].minAutoshipAmount;</span></a>
<a name="802"><span class="lineNum">     802 </span>        [<span class="branchCov" title="Branch 0 was taken 11 times"> + </span><span class="branchCov" title="Branch 1 was taken 32 times"> + </span>]:<span class="lineCov">         32 :             if (_checkRedeemableOutstanding(valCheckpoint, minAmountForValidator)) {</span></a>
<a name="803"><span class="lineNum">     803 </span>                :<span class="lineCov">         11 :                 autopayRecipients[assigned] = current_validator;</span></a>
<a name="804"><span class="lineNum">     804 </span>                :<span class="lineCov">         11 :                 ++assigned;</span></a>
<a name="805"><span class="lineNum">     805 </span>                :            :             }</a>
<a name="806"><span class="lineNum">     806 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 30 times"> + </span>]:<span class="lineCov">         32 :             if (assigned &gt;= _batch_size) {</span></a>
<a name="807"><span class="lineNum">     807 </span>                :<span class="lineCov">          2 :                 break;</span></a>
<a name="808"><span class="lineNum">     808 </span>                :            :             }</a>
<a name="809"><span class="lineNum">     809 </span>                :            :         }</a>
<a name="810"><span class="lineNum">     810 </span>                :<span class="lineCov">         22 :         hasJobs = assigned &gt; 0;</span></a>
<a name="811"><span class="lineNum">     811 </span>                :            :     }</a>
<a name="812"><span class="lineNum">     812 </span>                :            : </a>
<a name="813"><span class="lineNum">     813 </span>                :            :     /// @notice Gets the status of an address</a>
<a name="814"><span class="lineNum">     814 </span>                :            :     /// @dev Contains (activeAtAuctionRound, inactiveAtAuctionRound, statusType)</a>
<a name="815"><span class="lineNum">     815 </span>                :            :     /// @param _who Address we want the status of</a>
<a name="816"><span class="lineNum">     816 </span>                :            :     /// @return Status Status of the given address</a>
<a name="817"><span class="lineNum">     817 </span>                :            :     function getStatus(address _who) external view returns (Status memory) {</a>
<a name="818"><span class="lineNum">     818 </span>                :<span class="lineCov">          2 :         return statusMap[_who];</span></a>
<a name="819"><span class="lineNum">     819 </span>                :            :     }</a>
<a name="820"><span class="lineNum">     820 </span>                :            : </a>
<a name="821"><span class="lineNum">     821 </span>                :            :     /// @notice Gets the validators involved with a given auction</a>
<a name="822"><span class="lineNum">     822 </span>                :            :     /// @dev validatorsactiveAtAuctionRound being an EnumerableSet</a>
<a name="823"><span class="lineNum">     823 </span>                :            :     /// @param _auction_index Auction Round</a>
<a name="824"><span class="lineNum">     824 </span>                :            :     /// @return Array of validator addresses that received a bid during round `_auction_index`</a>
<a name="825"><span class="lineNum">     825 </span>                :            :     function getValidatorsactiveAtAuctionRound(uint128 _auction_index) external view returns (address[] memory) {</a>
<a name="826"><span class="lineNum">     826 </span>                :<span class="lineCov">          3 :         return validatorsactiveAtAuctionRound[_auction_index].values();</span></a>
<a name="827"><span class="lineNum">     827 </span>                :            :     }</a>
<a name="828"><span class="lineNum">     828 </span>                :            : </a>
<a name="829"><span class="lineNum">     829 </span>                :            : </a>
<a name="830"><span class="lineNum">     830 </span>                :            :     /// @notice Gets the auction number for which the fast lane privileges are active</a>
<a name="831"><span class="lineNum">     831 </span>                :            :     /// @return auction round</a>
<a name="832"><span class="lineNum">     832 </span>                :            :     function getActivePrivilegesAuctionNumber() public view returns (uint128) {</a>
<a name="833"><span class="lineNum">     833 </span>                :<span class="lineCov">          3 :         return auction_number - 1;</span></a>
<a name="834"><span class="lineNum">     834 </span>                :            :     }</a>
<a name="835"><span class="lineNum">     835 </span>                :            : </a>
<a name="836"><span class="lineNum">     836 </span>                :            :     /// @notice Gets the checkpoint of an address</a>
<a name="837"><span class="lineNum">     837 </span>                :            :     /// @param _who Address we want the checkpoint of</a>
<a name="838"><span class="lineNum">     838 </span>                :            :     /// @return Validator checkpoint</a>
<a name="839"><span class="lineNum">     839 </span>                :            :     function getCheckpoint(address _who) external view returns (ValidatorBalanceCheckpoint memory) {</a>
<a name="840"><span class="lineNum">     840 </span>                :<span class="lineCov">         13 :         return validatorsCheckpoints[_who];</span></a>
<a name="841"><span class="lineNum">     841 </span>                :            :     }</a>
<a name="842"><span class="lineNum">     842 </span>                :            :  </a>
<a name="843"><span class="lineNum">     843 </span>                :            :     /// @notice Gets the preferences of an address</a>
<a name="844"><span class="lineNum">     844 </span>                :            :     /// @param _who Address we want the preferences of</a>
<a name="845"><span class="lineNum">     845 </span>                :            :     /// @return Validator preferences</a>
<a name="846"><span class="lineNum">     846 </span>                :            :     function getPreferences(address _who) external view returns (ValidatorPreferences memory) {</a>
<a name="847"><span class="lineNum">     847 </span>                :<span class="lineCov">          1 :         return validatorsPreferences[_who];</span></a>
<a name="848"><span class="lineNum">     848 </span>                :            :     }</a>
<a name="849"><span class="lineNum">     849 </span>                :            : </a>
<a name="850"><span class="lineNum">     850 </span>                :            :     /// @notice Determines the current top bid of a pair for the current ongoing (live) auction</a>
<a name="851"><span class="lineNum">     851 </span>                :            :     /// @param _validatorAddress Validator for the given pair</a>
<a name="852"><span class="lineNum">     852 </span>                :            :     /// @param _opportunityAddress Opportunity for the given pair</a>
<a name="853"><span class="lineNum">     853 </span>                :            :     /// @return Tuple (bidAmount, auction_round)</a>
<a name="854"><span class="lineNum">     854 </span>                :            :     function findLiveAuctionTopBid(address _validatorAddress, address _opportunityAddress)</a>
<a name="855"><span class="lineNum">     855 </span>                :            :         external</a>
<a name="856"><span class="lineNum">     856 </span>                :            :         view</a>
<a name="857"><span class="lineNum">     857 </span>                :            :         atLiveStage</a>
<a name="858"><span class="lineNum">     858 </span>                :            :         returns (uint256, uint128)</a>
<a name="859"><span class="lineNum">     859 </span>                :            :     {</a>
<a name="860"><span class="lineNum">     860 </span>                :<span class="lineCov">          2 :             Bid memory topBid = auctionsMap[auction_number][</span></a>
<a name="861"><span class="lineNum">     861 </span>                :            :                 _validatorAddress</a>
<a name="862"><span class="lineNum">     862 </span>                :            :             ][_opportunityAddress];</a>
<a name="863"><span class="lineNum">     863 </span>                :<span class="lineCov">          2 :             return (topBid.bidAmount, auction_number);</span></a>
<a name="864"><span class="lineNum">     864 </span>                :            :     }</a>
<a name="865"><span class="lineNum">     865 </span>                :            : </a>
<a name="866"><span class="lineNum">     866 </span>                :            :     /// @notice Returns the top bid of a past auction round for a given pair</a>
<a name="867"><span class="lineNum">     867 </span>                :            :     /// @param _auction_index Auction round</a>
<a name="868"><span class="lineNum">     868 </span>                :            :     /// @param _validatorAddress Validator for the given pair</a>
<a name="869"><span class="lineNum">     869 </span>                :            :     /// @param _opportunityAddress Opportunity for the given pair</a>
<a name="870"><span class="lineNum">     870 </span>                :            :     /// @return Tuple (true|false, winningSearcher, auction_index)</a>
<a name="871"><span class="lineNum">     871 </span>                :            :     function findFinalizedAuctionWinnerAtAuction(</a>
<a name="872"><span class="lineNum">     872 </span>                :            :         uint128 _auction_index,</a>
<a name="873"><span class="lineNum">     873 </span>                :            :         address _validatorAddress,</a>
<a name="874"><span class="lineNum">     874 </span>                :            :         address _opportunityAddress</a>
<a name="875"><span class="lineNum">     875 </span>                :            :     ) public view</a>
<a name="876"><span class="lineNum">     876 </span>                :            :                 returns (</a>
<a name="877"><span class="lineNum">     877 </span>                :            :             bool,</a>
<a name="878"><span class="lineNum">     878 </span>                :            :             address,</a>
<a name="879"><span class="lineNum">     879 </span>                :            :             uint128</a>
<a name="880"><span class="lineNum">     880 </span>                :            :         )</a>
<a name="881"><span class="lineNum">     881 </span>                :            :     {</a>
<a name="882"><span class="lineNum">     882 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchCov" title="Branch 1 was taken 3 times"> + </span>]:<span class="lineCov">          3 :         if (_auction_index &gt;= auction_number) revert InequalityInvalidIndex();</span></a>
<a name="883"><span class="lineNum">     883 </span>                :            :         // Get the winning searcher</a>
<a name="884"><span class="lineNum">     884 </span>                :<span class="lineCov">          3 :         address winningSearcher = auctionsMap[_auction_index][</span></a>
<a name="885"><span class="lineNum">     885 </span>                :            :             _validatorAddress</a>
<a name="886"><span class="lineNum">     886 </span>                :            :         ][_opportunityAddress].searcherContractAddress;</a>
<a name="887"><span class="lineNum">     887 </span>                :            : </a>
<a name="888"><span class="lineNum">     888 </span>                :            :         // Check if there is a winning searcher (no bids mean the winner is address(0))</a>
<a name="889"><span class="lineNum">     889 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          3 :         if (winningSearcher != address(0)) {</span></a>
<a name="890"><span class="lineNum">     890 </span>                :<span class="lineCov">          2 :             return (true, winningSearcher, _auction_index);</span></a>
<a name="891"><span class="lineNum">     891 </span>                :            :         } else {</a>
<a name="892"><span class="lineNum">     892 </span>                :<span class="lineCov">          1 :             return (false, winningSearcher, _auction_index);</span></a>
<a name="893"><span class="lineNum">     893 </span>                :            :         }</a>
<a name="894"><span class="lineNum">     894 </span>                :            :     }</a>
<a name="895"><span class="lineNum">     895 </span>                :            : </a>
<a name="896"><span class="lineNum">     896 </span>                :            :     /// @notice Returns the the winner of the last completed auction for a given pair</a>
<a name="897"><span class="lineNum">     897 </span>                :            :     /// @param _validatorAddress Validator for the given pair</a>
<a name="898"><span class="lineNum">     898 </span>                :            :     /// @param _opportunityAddress Opportunity for the given pair</a>
<a name="899"><span class="lineNum">     899 </span>                :            :     /// @return Tuple (true|false, winningSearcher, auction_index)</a>
<a name="900"><span class="lineNum">     900 </span>                :            :     function findLastFinalizedAuctionWinner(</a>
<a name="901"><span class="lineNum">     901 </span>                :            :         address _validatorAddress,</a>
<a name="902"><span class="lineNum">     902 </span>                :            :         address _opportunityAddress</a>
<a name="903"><span class="lineNum">     903 </span>                :            :     )</a>
<a name="904"><span class="lineNum">     904 </span>                :            :         external</a>
<a name="905"><span class="lineNum">     905 </span>                :            :         view</a>
<a name="906"><span class="lineNum">     906 </span>                :            :         returns (</a>
<a name="907"><span class="lineNum">     907 </span>                :            :             bool,</a>
<a name="908"><span class="lineNum">     908 </span>                :            :             address,</a>
<a name="909"><span class="lineNum">     909 </span>                :            :             uint128</a>
<a name="910"><span class="lineNum">     910 </span>                :            :         )</a>
<a name="911"><span class="lineNum">     911 </span>                :            :     {</a>
<a name="912"><span class="lineNum">     912 </span>                :<span class="lineCov">          1 :         return findFinalizedAuctionWinnerAtAuction(getActivePrivilegesAuctionNumber(), _validatorAddress, _opportunityAddress);</span></a>
<a name="913"><span class="lineNum">     913 </span>                :            :     }</a>
<a name="914"><span class="lineNum">     914 </span>                :            : </a>
<a name="915"><span class="lineNum">     915 </span>                :            :   /***********************************|</a>
<a name="916"><span class="lineNum">     916 </span>                :            :   |             Modifiers             |</a>
<a name="917"><span class="lineNum">     917 </span>                :            :   |__________________________________*/</a>
<a name="918"><span class="lineNum">     918 </span>                :            : </a>
<a name="919"><span class="lineNum">     919 </span>                :            :     modifier notLiveStage() {</a>
<a name="920"><span class="lineNum">     920 </span>                :            :         if (auction_live) revert TimeNotWhenAuctionIsLive();</a>
<a name="921"><span class="lineNum">     921 </span>                :            :         _;</a>
<a name="922"><span class="lineNum">     922 </span>                :            :     }</a>
<a name="923"><span class="lineNum">     923 </span>                :            : </a>
<a name="924"><span class="lineNum">     924 </span>                :            :     modifier atLiveStage() {</a>
<a name="925"><span class="lineNum">     925 </span>                :            :         if (!auction_live) revert TimeNotWhenAuctionIsStopped();</a>
<a name="926"><span class="lineNum">     926 </span>                :            :         _;</a>
<a name="927"><span class="lineNum">     927 </span>                :            :     }</a>
<a name="928"><span class="lineNum">     928 </span>                :            : </a>
<a name="929"><span class="lineNum">     929 </span>                :            :     modifier whenNotPaused() {</a>
<a name="930"><span class="lineNum">     930 </span>                :            :         if (paused) revert PermissionPaused();</a>
<a name="931"><span class="lineNum">     931 </span>                :            :         _;</a>
<a name="932"><span class="lineNum">     932 </span>                :            :     }</a>
<a name="933"><span class="lineNum">     933 </span>                :            : </a>
<a name="934"><span class="lineNum">     934 </span>                :            :     modifier onlyValidator() {</a>
<a name="935"><span class="lineNum">     935 </span>                :            :         if(statusMap[msg.sender].kind != statusType.VALIDATOR) revert PermissionMustBeValidator();</a>
<a name="936"><span class="lineNum">     936 </span>                :            :         _;</a>
<a name="937"><span class="lineNum">     937 </span>                :            :     }</a>
<a name="938"><span class="lineNum">     938 </span>                :            : </a>
<a name="939"><span class="lineNum">     939 </span>                :            :     modifier onlyOwnerStarterOps() {</a>
<a name="940"><span class="lineNum">     940 </span>                :            :         if (msg.sender != ops &amp;&amp; msg.sender != auctionStarter &amp;&amp; msg.sender != owner()) revert PermissionOnlyOps();</a>
<a name="941"><span class="lineNum">     941 </span>                :            :         _;</a>
<a name="942"><span class="lineNum">     942 </span>                :            :     }</a>
<a name="943"><span class="lineNum">     943 </span>                :            : </a>
<a name="944"><span class="lineNum">     944 </span>                :            :     modifier onlyStarterOrOwner() {</a>
<a name="945"><span class="lineNum">     945 </span>                :            :         if (msg.sender != auctionStarter &amp;&amp; msg.sender != owner()) revert PermissionNotOwnerNorStarter();</a>
<a name="946"><span class="lineNum">     946 </span>                :            :         _;</a>
<a name="947"><span class="lineNum">     947 </span>                :            :     }</a>
<a name="948"><span class="lineNum">     948 </span>                :            : }</a>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="https://github.com/linux-test-project/lcov" target="_parent">LCOV version 1.16</a></td></tr>
  </table>
  <br>

</body>
</html>
